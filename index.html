<!DOCTYPE html>  
<html lang="en">  
<head>  
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  
    <title>Profit First: Interactive Business Guide</title>  
    <!-- Tailwind CSS -->  
    <script src="https://cdn.tailwindcss.com"></script>  
    <!-- Chart.js -->  
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>  
    <!-- Google Fonts -->  
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@500;700;800&family=Source+Sans+3:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">

    <style>  
        :root {
            --bg: #f8f4ea;
            --ink: #102a43;
            --muted: #486581;
            --line: rgba(16, 42, 67, 0.12);
            --teal: #0f8b8d;
            --teal-dark: #0a6f71;
            --amber: #f08c00;
            --panel: rgba(255, 255, 255, 0.82);
            --shadow: 0 16px 44px rgba(16, 42, 67, 0.12);
            --trend-main: rgba(15, 139, 141, 0.38);
            --trend-soft: rgba(15, 139, 141, 0.2);
            --trend-accent: rgba(10, 111, 113, 0.55);
            --grid-line: rgba(16, 42, 67, 0.08);
        }

        body {  
            font-family: 'Source Sans 3', sans-serif;
            color: var(--ink);
            background:
                linear-gradient(165deg, rgba(255, 255, 255, 0.38), rgba(255, 255, 255, 0)),
                var(--bg);
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            pointer-events: none;
            background-image: linear-gradient(rgba(255, 255, 255, 0.08) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.08) 1px, transparent 1px);
            background-size: 24px 24px;
            opacity: 0.25;
            z-index: -3;
        }

        .bg-atmosphere {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: -2;
            overflow: hidden;
        }

        .bg-graph-grid {
            position: absolute;
            inset: 0;
            background-image:
                linear-gradient(var(--grid-line) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid-line) 1px, transparent 1px);
            background-size: 30px 30px;
            opacity: 0.36;
            mask-image: radial-gradient(circle at center, rgba(0, 0, 0, 0.95), rgba(0, 0, 0, 0.1) 78%, transparent 100%);
        }

        .bg-graph-layer {
            position: absolute;
            inset: -12% -10%;
            width: 120%;
            height: 124%;
            overflow: visible;
            transform-origin: center;
        }

        .bg-graph-layer path {
            fill: none;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .bg-graph-layer.layer-a {
            opacity: 0.42;
            animation: graphPanA 30s linear infinite;
        }

        .bg-graph-layer.layer-b {
            opacity: 0.28;
            animation: graphPanB 38s linear infinite;
        }

        .bg-graph-layer.layer-c {
            opacity: 0.24;
            animation: graphPanC 46s ease-in-out infinite;
        }

        .bg-graph-layer .line-main {
            stroke: var(--trend-main);
            stroke-width: 3;
            stroke-dasharray: 10 12;
            animation: graphDash 24s linear infinite;
        }

        .bg-graph-layer .line-soft {
            stroke: var(--trend-soft);
            stroke-width: 2;
            stroke-dasharray: 5 10;
            animation: graphDashReverse 28s linear infinite;
        }

        .bg-graph-layer .line-accent {
            stroke: var(--trend-accent);
            stroke-width: 2.6;
            stroke-dasharray: 14 10;
            animation: graphDash 20s linear infinite;
        }

        .bg-graph-layer circle {
            fill: rgba(255, 255, 255, 0.66);
            stroke: var(--trend-accent);
            stroke-width: 1.6;
            animation: graphBlink 6s ease-in-out infinite;
        }

        .bg-graph-layer circle.delay-1 { animation-delay: 1.1s; }
        .bg-graph-layer circle.delay-2 { animation-delay: 2.2s; }
        .bg-graph-layer circle.delay-3 { animation-delay: 3.3s; }

        .bg-graph-haze {
            position: absolute;
            inset: 0;
            background: radial-gradient(60% 50% at 50% 100%, rgba(255, 255, 255, 0.55), transparent 80%);
            opacity: 0.8;
        }

        header,
        main,
        footer {
            opacity: 0;
            transform: translateY(12px);
            transition: opacity 0.6s ease, transform 0.6s ease;
        }

        body.app-ready header,
        body.app-ready main,
        body.app-ready footer {
            opacity: 1;
            transform: translateY(0);
        }

        body.app-ready main { transition-delay: 0.08s; }
        body.app-ready footer { transition-delay: 0.14s; }

        .tab-panel {
            will-change: opacity, transform, filter;
        }

        .tab-panel-in {
            animation: tabEnter 0.5s cubic-bezier(0.22, 1, 0.36, 1) both;
        }

        .tab-panel-out {
            animation: tabExit 0.22s ease both;
            pointer-events: none;
        }

        .motion-seed {
            animation: tileIn 0.5s cubic-bezier(0.22, 1, 0.36, 1) both;
        }

        h1, h2, h3, h4 {
            font-family: 'Syne', sans-serif;
            letter-spacing: -0.02em;
        }

        .mono {
            font-family: 'IBM Plex Mono', monospace;
        }

        .panel-shell {
            background: var(--panel);
            border: 1px solid var(--line);
            border-radius: 1.4rem;
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);
            transition: transform 0.28s ease, box-shadow 0.28s ease, border-color 0.28s ease;
        }

        .sub-panel {
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid var(--line);
            border-radius: 1rem;
            transition: transform 0.24s ease, box-shadow 0.24s ease, border-color 0.24s ease;
        }

        .nav-chip {
            border-radius: 999px;
            padding: 0.52rem 0.95rem;
            font-size: 0.88rem;
            transition: all 0.22s ease;
            border: 1px solid transparent;
        }

        .active-tab {
            color: #ffffff;
            background: linear-gradient(130deg, var(--teal), var(--teal-dark));
            border-color: rgba(10, 111, 113, 0.4);
            box-shadow: 0 8px 20px rgba(10, 111, 113, 0.24);
            font-weight: 700;
        }

        .inactive-tab {
            color: var(--muted);
            background: rgba(255, 255, 255, 0.68);
            border-color: rgba(16, 42, 67, 0.12);
            font-weight: 600;
        }

        .inactive-tab:hover {
            color: var(--ink);
            border-color: rgba(16, 42, 67, 0.2);
            transform: translateY(-2px);
        }

        .chart-container {  
            position: relative;  
            width: 100%;  
            max-width: 700px;
            margin-left: auto;  
            margin-right: auto;  
            height: 300px;  
            max-height: 420px;  
        }  

        @media (min-width: 768px) {  
            .chart-container {  
                height: 340px;  
            }  
        }

        input[type=number],
        input[type=text],
        textarea {
            border-radius: 0.75rem !important;
            border: 1px solid rgba(16, 42, 67, 0.2) !important;
            background: rgba(255, 255, 255, 0.96) !important;
        }

        input[type=number]:focus,
        input[type=text]:focus,
        textarea:focus {
            outline: none !important;
            border-color: rgba(15, 139, 141, 0.75) !important;
            box-shadow: 0 0 0 4px rgba(15, 139, 141, 0.16);
        }

        input[type=range] {  
            -webkit-appearance: none;  
            background: transparent;  
        }  

        input[type=range]::-webkit-slider-runnable-track {  
            width: 100%;  
            height: 6px;  
            border-radius: 999px;  
            background: linear-gradient(90deg, rgba(15, 139, 141, 0.22), rgba(240, 140, 0, 0.28));  
        }  

        input[type=range]::-webkit-slider-thumb {  
            -webkit-appearance: none;  
            margin-top: -7px;  
            width: 20px;  
            height: 20px;  
            border-radius: 50%;  
            border: 3px solid var(--teal);  
            background: #ffffff;  
            box-shadow: 0 2px 10px rgba(16, 42, 67, 0.2);  
            cursor: pointer;  
        }

        .loading-spinner {  
            border: 3px solid rgba(15, 139, 141, 0.2);  
            border-top: 3px solid var(--teal);  
            border-radius: 50%;  
            width: 20px;  
            height: 20px;  
            animation: spin 1s linear infinite;  
            display: inline-block;  
        }  

        button {
            transition: transform 0.2s ease, box-shadow 0.2s ease, filter 0.2s ease;
        }

        @media (hover: hover) and (pointer: fine) {
            button:hover:not(:disabled) {
                transform: translateY(-1px);
            }

            .panel-shell:hover {
                transform: translateY(-2px);
                border-color: rgba(16, 42, 67, 0.2);
                box-shadow: 0 20px 48px rgba(16, 42, 67, 0.15);
            }

            .sub-panel:hover {
                transform: translateY(-2px);
                border-color: rgba(16, 42, 67, 0.18);
                box-shadow: 0 14px 30px rgba(16, 42, 67, 0.09);
            }
        }

        @keyframes spin {  
            0% { transform: rotate(0deg); }  
            100% { transform: rotate(360deg); }  
        }

        @keyframes riseIn {
            from { opacity: 0; transform: translateY(12px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .reveal { animation: riseIn 0.6s ease both; }
        .reveal.delay-1 { animation-delay: 0.08s; }
        .reveal.delay-2 { animation-delay: 0.16s; }
        .reveal.delay-3 { animation-delay: 0.24s; }

        @keyframes tabEnter {
            from { opacity: 0; transform: translateY(14px) scale(0.992); filter: blur(1px); }
            to { opacity: 1; transform: translateY(0) scale(1); filter: blur(0); }
        }

        @keyframes tabExit {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(8px); }
        }

        @keyframes tileIn {
            from { opacity: 0; transform: translateY(10px) scale(0.995); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        @keyframes graphPanA {
            0% { transform: translateX(-2%) translateY(0); }
            50% { transform: translateX(2%) translateY(-1.2%); }
            100% { transform: translateX(-2%) translateY(0); }
        }

        @keyframes graphPanB {
            0% { transform: translateX(3%) translateY(0); }
            50% { transform: translateX(-3%) translateY(1.1%); }
            100% { transform: translateX(3%) translateY(0); }
        }

        @keyframes graphPanC {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-1.4%); }
        }

        @keyframes graphDash {
            from { stroke-dashoffset: 0; }
            to { stroke-dashoffset: -220; }
        }

        @keyframes graphDashReverse {
            from { stroke-dashoffset: 0; }
            to { stroke-dashoffset: 220; }
        }

        @keyframes graphBlink {
            0%, 100% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.18); opacity: 1; }
        }

        @media (prefers-reduced-motion: reduce) {
            * {
                animation: none !important;
                transition: none !important;
            }

            header, main, footer {
                opacity: 1;
                transform: none;
            }
        }
    </style>  
    <!-- Application Structure Plan:  
         1. Header: Simple branding and Introduction to the core philosophy.  
         2. Tabbed Navigation:   
            - Tab 1: Principles - Educational context.  
            - Tab 2: Assessment - Health check + ✨ AI Analysis.  
            - Tab 3: Allocation Tool - Real-time calculator.  
            - Tab 4: Strategy & Optimizer - ✨ AI Expense Auditor + Rollout plan.  
            - Tab 5: AI Coach - ✨ Methodology Q&A.  
         3. AI Integration: Uses the configured AI backend to provide personalized financial insights and categorize expense data.  
    -->  
</head>  
<body class="flex flex-col min-h-screen">
    <div class="bg-atmosphere" aria-hidden="true">
        <div class="bg-graph-grid"></div>
        <svg class="bg-graph-layer layer-a" viewBox="0 0 1200 700" xmlns="http://www.w3.org/2000/svg">
            <path class="line-main" d="M0 520 L120 500 L220 520 L340 460 L450 472 L570 420 L700 438 L820 370 L940 390 L1060 320 L1200 340" />
            <path class="line-soft" d="M0 610 L130 590 L250 602 L360 560 L500 572 L620 536 L760 546 L890 510 L1020 526 L1130 488 L1200 498" />
            <circle cx="340" cy="460" r="5" />
            <circle class="delay-1" cx="820" cy="370" r="5" />
            <circle class="delay-2" cx="1060" cy="320" r="6" />
        </svg>
        <svg class="bg-graph-layer layer-b" viewBox="0 0 1200 700" xmlns="http://www.w3.org/2000/svg">
            <path class="line-accent" d="M0 560 L110 544 L240 554 L350 516 L500 526 L630 484 L740 502 L880 456 L1020 470 L1140 438 L1200 446" />
            <path class="line-soft" d="M0 468 L130 456 L250 470 L360 436 L480 448 L620 402 L740 420 L860 376 L980 392 L1110 348 L1200 360" />
            <circle cx="500" cy="526" r="4.5" />
            <circle class="delay-1" cx="880" cy="456" r="4.5" />
            <circle class="delay-3" cx="1110" cy="348" r="5" />
        </svg>
        <svg class="bg-graph-layer layer-c" viewBox="0 0 1200 700" xmlns="http://www.w3.org/2000/svg">
            <path class="line-main" d="M0 650 L120 634 L240 640 L360 616 L500 624 L640 596 L760 606 L900 576 L1030 588 L1150 560 L1200 566" />
            <path class="line-soft" d="M0 420 L120 412 L220 422 L340 394 L470 402 L600 372 L740 386 L870 350 L1000 364 L1120 334 L1200 342" />
            <circle class="delay-2" cx="600" cy="372" r="4" />
            <circle cx="900" cy="576" r="4.5" />
        </svg>
        <div class="bg-graph-haze"></div>
    </div>

    <header class="sticky top-0 z-50 border-b border-slate-200/70 bg-[#fdfaf3]/85 backdrop-blur-lg">  
        <div class="max-w-7xl mx-auto px-4 py-4 sm:px-6 lg:px-8">  
            <div class="flex items-center justify-between gap-4">  
                <div>  
                    <span class="inline-flex items-center gap-2 rounded-full border border-slate-300/80 bg-white/70 px-3 py-1 text-xs font-bold uppercase tracking-[0.16em] text-slate-700 mono">$ Profit First Studio</span>  
                    <h1 class="mt-2 text-2xl font-bold tracking-tight text-slate-900 md:text-4xl">Build a Better Cash-Flow Operating System</h1>  
                    <p class="mt-2 max-w-3xl text-slate-600">Interactive Profit First diagnostics, allocation planning, and AI-guided decision support in one dashboard.</p>  
                </div>  
                <button class="md:hidden rounded-full border border-slate-300 bg-white/90 px-3 py-2 text-slate-700" onclick="document.getElementById('mobile-menu').classList.toggle('hidden')">  
                    Menu  
                </button>  
            </div>  
            <nav class="mt-4 hidden flex-wrap gap-2 md:flex">  
                <button onclick="switchTab('principles')" id="nav-principles" class="nav-chip active-tab">Core Principles</button>  
                <button onclick="switchTab('assessment')" id="nav-assessment" class="nav-chip inactive-tab">Instant Assessment</button>  
                <button onclick="switchTab('calculator')" id="nav-calculator" class="nav-chip inactive-tab">Allocation Tool</button>  
                <button onclick="switchTab('rollout')" id="nav-rollout" class="nav-chip inactive-tab">Strategy Optimizer</button>  
                <button onclick="switchTab('coach')" id="nav-coach" class="nav-chip inactive-tab">AI Coach</button>  
            </nav>  
            <div id="mobile-menu" class="hidden pb-2 pt-4 md:hidden">  
                <div class="flex flex-col gap-2">  
                    <button onclick="switchTab('principles')" class="text-left px-3 py-2 rounded-lg border border-slate-300 bg-white/85">Core Principles</button>  
                    <button onclick="switchTab('assessment')" class="text-left px-3 py-2 rounded-lg border border-slate-300 bg-white/85">Instant Assessment</button>  
                    <button onclick="switchTab('calculator')" class="text-left px-3 py-2 rounded-lg border border-slate-300 bg-white/85">Allocation Tool</button>  
                    <button onclick="switchTab('rollout')" class="text-left px-3 py-2 rounded-lg border border-slate-300 bg-white/85">Strategy Optimizer</button>  
                    <button onclick="switchTab('coach')" class="text-left px-3 py-2 rounded-lg border border-slate-300 bg-white/85">AI Coach</button>  
                </div>  
            </div>  
        </div>  
    </header>

    <!-- Main Content Area -->  
    <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full">

        <!-- TAB 1: CORE PRINCIPLES -->  
        <div id="tab-principles" class="tab-panel tab-panel-in space-y-6">  
            <div class="panel-shell p-6 md:p-8">  
                <div class="grid items-start gap-6 lg:grid-cols-12">  
                    <div class="space-y-4 lg:col-span-7 reveal">  
                        <p class="mono text-xs uppercase tracking-[0.18em] text-slate-500">Core Principles</p>  
                        <h2 class="text-3xl font-bold text-slate-900 md:text-4xl">Turn revenue into predictable profit before spending begins.</h2>  
                        <p class="text-lg text-slate-600 max-w-3xl">Profit First creates financial discipline at the bank-account level: allocate profit first, run operations on the remainder, then improve by 1% each quarter.</p>  
                        <div class="flex flex-wrap gap-2 text-sm">  
                            <span class="rounded-full border border-slate-300 bg-white/80 px-3 py-1.5">Allocate on the <strong>10th + 25th</strong></span>  
                            <span class="rounded-full border border-slate-300 bg-white/80 px-3 py-1.5">Operate through <strong>5 accounts</strong></span>  
                            <span class="rounded-full border border-slate-300 bg-white/80 px-3 py-1.5">Shift <strong>1% per quarter</strong></span>  
                        </div>  
                        <button onclick="switchTab('assessment')" class="bg-gradient-to-r from-teal-600 to-cyan-700 text-white px-5 py-2.5 rounded-lg text-sm font-bold shadow transition hover:opacity-95">Run My Assessment</button>  
                    </div>  

                    <div class="space-y-3 lg:col-span-5 reveal delay-1">  
                        <div class="sub-panel p-4">  
                            <p class="mb-2 text-xs uppercase tracking-[0.16em] text-slate-500">Formula Shift</p>  
                            <div class="grid grid-cols-1 gap-2 sm:grid-cols-2">  
                                <div class="rounded-xl border border-slate-200 bg-white p-3">  
                                    <p class="text-xs uppercase tracking-wide text-slate-500">Old</p>  
                                    <p class="mono mt-1 text-sm text-slate-700">Sales - Expenses = Profit?</p>  
                                </div>  
                                <div class="rounded-xl border border-teal-200 bg-teal-50 p-3">  
                                    <p class="text-xs uppercase tracking-wide text-teal-700">Profit First</p>  
                                    <p class="mono mt-1 text-sm font-bold text-slate-800">Sales - Profit = Expenses</p>  
                                </div>  
                            </div>  
                        </div>  

                        <div class="sub-panel p-4 space-y-3">  
                            <div class="flex items-center justify-between">  
                                <h3 class="text-sm uppercase tracking-[0.16em] text-slate-500">Quick Scenario</h3>  
                                <span id="core-profit-pct" class="rounded-full bg-teal-100 px-2.5 py-1 text-xs font-bold text-teal-700">5%</span>  
                            </div>  
                            <label class="block text-sm font-medium text-slate-700">Monthly Revenue</label>  
                            <input type="number" id="core-revenue-input" class="w-full border p-2 rounded-md" value="50000" oninput="updateCorePrinciplesDemo()">  
                            <input type="range" id="core-profit-slider" min="1" max="25" value="5" class="w-full" oninput="updateCorePrinciplesDemo()">  
                            <div class="grid grid-cols-2 gap-2">  
                                <div class="rounded-lg border border-teal-100 bg-teal-50 p-3">  
                                    <p class="text-xs uppercase tracking-wide text-teal-700">Profit Reserved</p>  
                                    <p id="core-profit-amount" class="text-lg font-bold text-teal-800">$0.00</p>  
                                </div>  
                                <div class="rounded-lg border border-slate-200 bg-slate-50 p-3">  
                                    <p class="text-xs uppercase tracking-wide text-slate-700">OpEx Budget</p>  
                                    <p id="core-opex-amount" class="text-lg font-bold text-slate-800">$0.00</p>  
                                </div>  
                            </div>  
                            <p id="core-savings-msg" class="text-xs text-slate-600"></p>  
                        </div>  
                    </div>  
                </div>  
            </div>

            <div class="grid grid-cols-1 gap-3 md:grid-cols-2 xl:grid-cols-5">  
                <div class="panel-shell p-4 border-t-4 border-slate-700 reveal">  
                    <div class="text-2xl" aria-hidden="true">&#128181;</div>  
                    <h4 class="mt-2 font-bold text-slate-900">1. Income</h4>  
                    <p class="mt-1 text-sm text-slate-600">Revenue lands here, then gets allocated intentionally.</p>  
                    <div class="mt-3 flex flex-wrap gap-1.5 text-xs">  
                        <span class="rounded-md bg-slate-100 px-2 py-1 text-slate-700">Watch: reactive spending</span>  
                        <span class="rounded-md bg-emerald-100 px-2 py-1 text-emerald-700">KPI: near $0 after allocation</span>  
                    </div>  
                </div>  
                <div class="panel-shell p-4 border-t-4 border-teal-600 reveal delay-1">  
                    <div class="text-2xl" aria-hidden="true">&#127873;</div>  
                    <h4 class="mt-2 font-bold text-slate-900">2. Profit</h4>  
                    <p class="mt-1 text-sm text-slate-600">Quarterly distributions plus long-term reserve.</p>  
                    <div class="mt-3 flex flex-wrap gap-1.5 text-xs">  
                        <span class="rounded-md bg-slate-100 px-2 py-1 text-slate-700">Watch: paper profit only</span>  
                        <span class="rounded-md bg-emerald-100 px-2 py-1 text-emerald-700">KPI: quarterly payouts</span>  
                    </div>  
                </div>  
                <div class="panel-shell p-4 border-t-4 border-blue-500 reveal delay-2">  
                    <div class="text-2xl" aria-hidden="true">&#128100;</div>  
                    <h4 class="mt-2 font-bold text-slate-900">3. Owner Comp</h4>  
                    <p class="mt-1 text-sm text-slate-600">Predictable salary for the owner-operator role.</p>  
                    <div class="mt-3 flex flex-wrap gap-1.5 text-xs">  
                        <span class="rounded-md bg-slate-100 px-2 py-1 text-slate-700">Watch: inconsistent pay</span>  
                        <span class="rounded-md bg-emerald-100 px-2 py-1 text-emerald-700">KPI: fixed pay cadence</span>  
                    </div>  
                </div>  
                <div class="panel-shell p-4 border-t-4 border-amber-500 reveal delay-3">  
                    <div class="text-2xl" aria-hidden="true">&#127963;</div>  
                    <h4 class="mt-2 font-bold text-slate-900">4. Tax</h4>  
                    <p class="mt-1 text-sm text-slate-600">Build tax coverage continuously through the year.</p>  
                    <div class="mt-3 flex flex-wrap gap-1.5 text-xs">  
                        <span class="rounded-md bg-slate-100 px-2 py-1 text-slate-700">Watch: deadline panic</span>  
                        <span class="rounded-md bg-emerald-100 px-2 py-1 text-emerald-700">KPI: funded tax account</span>  
                    </div>  
                </div>  
                <div class="panel-shell p-4 border-t-4 border-slate-500 reveal">  
                    <div class="text-2xl" aria-hidden="true">&#128736;</div>  
                    <h4 class="mt-2 font-bold text-slate-900">5. OpEx</h4>  
                    <p class="mt-1 text-sm text-slate-600">Operate within the remainder to force lean decisions.</p>  
                    <div class="mt-3 flex flex-wrap gap-1.5 text-xs">  
                        <span class="rounded-md bg-slate-100 px-2 py-1 text-slate-700">Watch: cost creep</span>  
                        <span class="rounded-md bg-emerald-100 px-2 py-1 text-emerald-700">KPI: TAP-aligned OpEx %</span>  
                    </div>  
                </div>  
            </div>  
        </div>

        <!-- TAB 2: INSTANT ASSESSMENT -->  
        <div id="tab-assessment" class="tab-panel hidden space-y-6">  
            <div class="panel-shell p-6 md:p-8">  
                <div class="grid grid-cols-1 gap-8 lg:grid-cols-12">  
                    <aside class="space-y-4 lg:col-span-4">  
                        <div class="flex items-center justify-between">  
                            <h3 class="text-2xl font-bold text-stone-900">Instant Assessment</h3>  
                            <span class="rounded-full bg-white/90 px-3 py-1 text-xs font-semibold text-slate-600 border border-slate-200">Annual View</span>  
                        </div>  
                        <p class="text-sm text-slate-600">Enter annual figures to compare your current CAPs against recommended TAP targets.</p>  

                        <div class="sub-panel p-4 space-y-4">  
                            <p class="text-xs uppercase tracking-[0.16em] text-slate-500">Revenue Setup</p>  
                            <p class="text-xs text-slate-600">Real Revenue = Top Line Revenue - Materials & Subs</p>  
                            <div>  
                                <label class="block text-sm font-medium text-stone-700">Top Line Revenue (Annual)</label>  
                                <input type="number" id="input-revenue" class="mt-1 block w-full border border-stone-300 rounded-md p-2" oninput="calculateAssessment()">  
                            </div>  
                            <div>  
                                <label class="block text-sm font-medium text-stone-700">Materials & Subs (Annual)</label>  
                                <input type="number" id="input-materials" class="mt-1 block w-full border border-stone-300 rounded-md p-2" oninput="calculateAssessment()">  
                            </div>  
                            <div class="rounded-lg border border-emerald-200 bg-emerald-50 p-3">  
                                <label class="text-xs font-bold uppercase tracking-wide text-emerald-800">Real Revenue</label>  
                                <div id="display-real-revenue" class="text-2xl font-bold text-emerald-700">$0.00</div>  
                            </div>  
                            <div class="grid grid-cols-2 gap-2">  
                                <button onclick="loadAssessmentSample()" class="rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm font-semibold text-slate-700 hover:bg-slate-50 transition">Load Sample</button>  
                                <button onclick="clearAssessmentInputs()" class="rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm font-semibold text-slate-700 hover:bg-slate-50 transition">Clear</button>  
                            </div>  
                        </div>

                        <div class="sub-panel p-4 space-y-3">  
                            <p class="text-xs uppercase tracking-[0.16em] text-slate-500">Current Allocations (Annual $)</p>  
                            <div>  
                                <label class="block text-sm font-medium text-stone-700">Profit Distribution</label>  
                                <input type="number" id="input-profit" class="mt-1 block w-full border border-stone-300 rounded-md p-2" oninput="calculateAssessment()">  
                            </div>  
                            <div>  
                                <label class="block text-sm font-medium text-stone-700">Owner's Pay</label>  
                                <input type="number" id="input-pay" class="mt-1 block w-full border border-stone-300 rounded-md p-2" oninput="calculateAssessment()">  
                            </div>  
                            <div>  
                                <label class="block text-sm font-medium text-stone-700">Tax Paid</label>  
                                <input type="number" id="input-tax" class="mt-1 block w-full border border-stone-300 rounded-md p-2" oninput="calculateAssessment()">  
                            </div>  
                            <div>  
                                <label class="block text-sm font-medium text-stone-700">Operating Expenses</label>  
                                <input type="number" id="input-opex" class="mt-1 block w-full border border-stone-300 rounded-md p-2" oninput="calculateAssessment()">  
                            </div>  
                        </div>

                        <div class="sub-panel p-4">  
                            <p id="assessment-tier-badge" class="inline-flex rounded-full bg-cyan-100 px-3 py-1 text-xs font-bold uppercase tracking-wide text-cyan-800">Target Tier: Starter</p>  
                            <p id="assessment-tier-note" class="mt-2 text-sm text-slate-600">Real Revenue below $250,000 maps to Starter TAP targets.</p>  
                        </div>  
                    </aside>

                    <section class="space-y-4 lg:col-span-8">  
                        <div class="flex flex-wrap items-start justify-between gap-3">  
                            <div>  
                                <h3 class="text-2xl font-bold text-stone-900">Diagnosis & Strategic Insight</h3>  
                                <p class="text-sm text-slate-600">Compare CAPs vs TAPs, identify biggest gap, and get AI-guided next actions.</p>  
                            </div>  
                            <div class="text-right">  
                                <button id="btn-ai-analyze" onclick="generateAIHealthAnalysis()" class="bg-gradient-to-r from-teal-600 to-cyan-700 text-white px-4 py-2 rounded-lg text-sm flex items-center gap-2 transition disabled:opacity-50 shadow">  
                                    <span id="ai-analyze-text">Get AI Analysis</span>  
                                    <div id="ai-analyze-loader" class="loading-spinner hidden"></div>  
                                </button>  
                                <p id="assessment-ai-hint" class="mt-2 text-xs text-slate-500">Enter revenue first to enable AI analysis.</p>  
                            </div>  
                        </div>

                        <div class="grid grid-cols-1 gap-3 sm:grid-cols-3">  
                            <div class="rounded-xl border border-slate-200 bg-white p-4">  
                                <p class="text-xs uppercase tracking-wide text-slate-500">Real Revenue</p>  
                                <p id="assessment-kpi-revenue" class="mt-1 text-xl font-bold text-slate-900">$0.00</p>  
                            </div>  
                            <div class="rounded-xl border border-slate-200 bg-white p-4">  
                                <p class="text-xs uppercase tracking-wide text-slate-500">Total CAP %</p>  
                                <p id="assessment-kpi-cap-total" class="mt-1 text-xl font-bold text-slate-900">0%</p>  
                            </div>  
                            <div class="rounded-xl border border-slate-200 bg-white p-4">  
                                <p class="text-xs uppercase tracking-wide text-slate-500">Biggest Gap</p>  
                                <p id="assessment-kpi-gap" class="mt-1 text-xl font-bold text-slate-900">N/A</p>  
                            </div>  
                        </div>
                          
                        <div class="sub-panel p-4">  
                            <p class="mb-3 text-xs uppercase tracking-[0.16em] text-slate-500">CAP vs TAP Distribution (%)</p>  
                            <div class="chart-container">  
                                <canvas id="assessmentChart"></canvas>  
                            </div>  
                        </div>

                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4" id="assessment-feedback">  
                            <div class="p-4 bg-white border border-stone-200 rounded-lg shadow-sm">  
                                <h4 class="font-bold text-stone-700">Enter your numbers to generate diagnosis cards.</h4>  
                            </div>  
                        </div>

                        <div id="ai-analysis-container" class="hidden p-6 bg-emerald-50 border border-emerald-200 rounded-xl space-y-4">  
                            <h4 class="font-bold text-emerald-800 flex items-center gap-2">AI Strategy Brief</h4>  
                            <div id="ai-analysis-content" class="text-stone-700 text-sm leading-relaxed whitespace-pre-line"></div>  
                        </div>
                    </section>  
                </div>  
            </div>  
        </div>

        <!-- TAB 3: ALLOCATION CALCULATOR -->  
        <div id="tab-calculator" class="tab-panel hidden space-y-8">  
            <div class="panel-shell p-6 md:p-8">  
                <div class="mb-6 flex flex-wrap items-start justify-between gap-4">  
                    <div>  
                        <h3 class="text-2xl font-bold text-stone-900">Allocation Tool</h3>  
                        <p class="mt-1 text-sm text-slate-600">Model your next transfer run and balance Profit, Owner Pay, Tax, and OpEx in real time.</p>  
                    </div>  
                    <div class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-3 py-1.5 text-xs font-semibold text-slate-600">  
                        <span class="h-2 w-2 rounded-full bg-emerald-500"></span>  
                        Biweekly Allocation Ready  
                    </div>  
                </div>

                <div class="grid grid-cols-1 gap-8 lg:grid-cols-12">  
                    <aside class="lg:col-span-5 space-y-4">  
                        <div class="sub-panel p-5 space-y-4">  
                            <div>  
                                <label class="block text-xs font-bold uppercase tracking-[0.16em] text-slate-500">Current Income Balance</label>  
                                <input type="number" id="calc-income" class="mt-2 w-full border p-3 text-lg font-semibold" value="10000" oninput="updateAllocationCalc()">  
                            </div>  
                            <div class="grid grid-cols-3 gap-2">  
                                <button onclick="setAllocationIncome(5000)" class="rounded-lg border border-slate-300 bg-white px-2 py-2 text-xs font-semibold text-slate-700 transition hover:bg-slate-50">$5k</button>  
                                <button onclick="setAllocationIncome(10000)" class="rounded-lg border border-slate-300 bg-white px-2 py-2 text-xs font-semibold text-slate-700 transition hover:bg-slate-50">$10k</button>  
                                <button onclick="setAllocationIncome(25000)" class="rounded-lg border border-slate-300 bg-white px-2 py-2 text-xs font-semibold text-slate-700 transition hover:bg-slate-50">$25k</button>  
                            </div>  
                        </div>

                        <div class="sub-panel p-5 space-y-5">  
                            <div class="flex flex-wrap items-center justify-between gap-2">  
                                <p class="text-xs font-bold uppercase tracking-[0.16em] text-slate-500">Set Allocation Mix (%)</p>  
                                <div class="flex gap-2">  
                                    <button onclick="setAllocationPreset('starter')" class="rounded-md border border-slate-300 bg-white px-2 py-1 text-xs font-semibold text-slate-700 hover:bg-slate-50">Starter</button>  
                                    <button onclick="setAllocationPreset('growth')" class="rounded-md border border-slate-300 bg-white px-2 py-1 text-xs font-semibold text-slate-700 hover:bg-slate-50">Growth</button>  
                                    <button onclick="setAllocationPreset('scale')" class="rounded-md border border-slate-300 bg-white px-2 py-1 text-xs font-semibold text-slate-700 hover:bg-slate-50">Scale</button>  
                                </div>  
                            </div>

                            <div class="space-y-2">  
                                <div class="flex items-center justify-between">  
                                    <label class="text-sm font-semibold text-stone-800">Profit</label>  
                                    <span id="val-profit-pct" class="rounded-full bg-emerald-100 px-2.5 py-0.5 text-xs font-bold text-emerald-700">5%</span>  
                                </div>  
                                <input type="range" id="slider-profit" min="0" max="50" value="5" class="w-full" oninput="updateAllocationCalc('slider-profit')">  
                                <p class="text-xs text-slate-500">Reserve first to build resilience and quarterly distribution capacity.</p>  
                            </div>

                            <div class="space-y-2">  
                                <div class="flex items-center justify-between">  
                                    <label class="text-sm font-semibold text-stone-800">Owner's Pay</label>  
                                    <span id="val-comp-pct" class="rounded-full bg-blue-100 px-2.5 py-0.5 text-xs font-bold text-blue-700">50%</span>  
                                </div>  
                                <input type="range" id="slider-comp" min="0" max="80" value="50" class="w-full" oninput="updateAllocationCalc('slider-comp')">  
                                <p class="text-xs text-slate-500">Pay the owner role consistently before discretionary spending decisions.</p>  
                            </div>

                            <div class="space-y-2">  
                                <div class="flex items-center justify-between">  
                                    <label class="text-sm font-semibold text-stone-800">Tax</label>  
                                    <span id="val-tax-pct" class="rounded-full bg-amber-100 px-2.5 py-0.5 text-xs font-bold text-amber-700">15%</span>  
                                </div>  
                                <input type="range" id="slider-tax" min="0" max="50" value="15" class="w-full" oninput="updateAllocationCalc('slider-tax')">  
                                <p class="text-xs text-slate-500">Fund tax obligations continuously to avoid deadline-driven cash shocks.</p>  
                            </div>
                        </div>

                        <div class="rounded-xl border border-slate-200 bg-white p-4">  
                            <div class="grid grid-cols-2 gap-3">  
                                <div>  
                                    <p class="text-xs uppercase tracking-wide text-slate-500">Allocated</p>  
                                    <p id="out-total-allocated" class="text-xl font-bold text-slate-900">70%</p>  
                                </div>  
                                <div>  
                                    <p class="text-xs uppercase tracking-wide text-slate-500">Remaining OpEx</p>  
                                    <p id="out-opex-pct" class="text-xl font-bold text-slate-900">30%</p>  
                                </div>  
                            </div>  
                            <div class="mt-3 h-2 w-full overflow-hidden rounded-full bg-slate-200">  
                                <div id="bar-opex" class="h-full rounded-full bg-slate-600 transition-all duration-200" style="width: 30%"></div>  
                            </div>  
                            <p id="allocation-health" class="mt-3 inline-flex rounded-full bg-emerald-100 px-2.5 py-1 text-xs font-bold text-emerald-700">Balanced Mix</p>  
                            <p id="allocation-health-note" class="mt-2 text-xs text-slate-600">You are preserving enough room for operational capacity.</p>  
                        </div>
                    </aside>

                    <section class="lg:col-span-7 space-y-4">  
                        <div class="grid grid-cols-1 gap-3 sm:grid-cols-2">  
                            <div class="rounded-xl border border-emerald-200 bg-emerald-50 p-4">  
                                <p class="text-xs uppercase font-bold tracking-wide text-emerald-700">Transfer to Profit</p>  
                                <p id="out-profit" class="mt-1 text-2xl font-bold text-emerald-800">$0.00</p>  
                            </div>  
                            <div class="rounded-xl border border-blue-200 bg-blue-50 p-4">  
                                <p class="text-xs uppercase font-bold tracking-wide text-blue-700">Transfer to Owner Pay</p>  
                                <p id="out-comp" class="mt-1 text-2xl font-bold text-blue-800">$0.00</p>  
                            </div>  
                            <div class="rounded-xl border border-amber-200 bg-amber-50 p-4">  
                                <p class="text-xs uppercase font-bold tracking-wide text-amber-700">Transfer to Tax</p>  
                                <p id="out-tax" class="mt-1 text-2xl font-bold text-amber-800">$0.00</p>  
                            </div>  
                            <div class="rounded-xl border border-slate-300 bg-slate-50 p-4">  
                                <p class="text-xs uppercase font-bold tracking-wide text-slate-700">Operating Budget</p>  
                                <p id="out-opex" class="mt-1 text-2xl font-bold text-slate-800">$0.00</p>  
                            </div>  
                        </div>

                        <div class="sub-panel p-4">  
                            <p class="mb-2 text-xs uppercase tracking-[0.16em] text-slate-500">Allocation Distribution</p>  
                            <p class="mb-3 text-xs text-slate-600">Donut view of where each incoming dollar is assigned for this run.</p>  
                            <div class="chart-container" style="height: 260px;">  
                                <canvas id="allocationDonut"></canvas>  
                            </div>  
                        </div>

                        <div class="sub-panel p-4">  
                            <div class="flex items-center justify-between gap-3">  
                                <p class="text-sm font-bold text-stone-800">Transfer Checklist</p>  
                                <p class="text-xs uppercase tracking-wide text-slate-500">Execute in sequence</p>  
                            </div>  
                            <div class="mt-3 grid grid-cols-1 gap-2 text-sm sm:grid-cols-2">  
                                <div class="rounded-lg border border-slate-200 bg-white p-3 text-slate-700">1. Profit: <span id="check-profit-amt" class="font-bold text-slate-900">$0.00</span></div>  
                                <div class="rounded-lg border border-slate-200 bg-white p-3 text-slate-700">2. Owner Pay: <span id="check-comp-amt" class="font-bold text-slate-900">$0.00</span></div>  
                                <div class="rounded-lg border border-slate-200 bg-white p-3 text-slate-700">3. Tax: <span id="check-tax-amt" class="font-bold text-slate-900">$0.00</span></div>  
                                <div class="rounded-lg border border-slate-200 bg-white p-3 text-slate-700">4. OpEx Cap: <span id="check-opex-amt" class="font-bold text-slate-900">$0.00</span></div>  
                            </div>  
                        </div>
                    </section>  
                </div>  
            </div>  
        </div>

        <!-- TAB 4: ROLLOUT & ✨ EXPENSE OPTIMIZER -->  
        <div id="tab-rollout" class="tab-panel hidden space-y-8">  
            <div class="panel-shell p-6 md:p-8">  
                <div class="mb-6 flex flex-wrap items-start justify-between gap-4">  
                    <div>  
                        <h3 class="text-2xl font-bold text-stone-900">Strategy Optimizer</h3>  
                        <p class="mt-1 text-sm text-slate-600">Run a fast operating-expense audit and identify immediate keep, cut, and review actions.</p>  
                    </div>  
                    <div class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-3 py-1.5 text-xs font-semibold text-slate-600">  
                        <span class="h-2 w-2 rounded-full bg-cyan-500"></span>  
                        AI Audit Workspace  
                    </div>  
                </div>

                <div class="grid grid-cols-1 gap-6 lg:grid-cols-12">  
                    <aside class="space-y-4 lg:col-span-5">  
                        <div class="sub-panel p-5 space-y-4">  
                            <div class="flex items-center justify-between gap-3">  
                                <p class="text-xs font-bold uppercase tracking-[0.16em] text-slate-500">Expense Input</p>  
                                <div class="flex gap-2">  
                                    <button onclick="loadExpenseSample()" class="rounded-md border border-slate-300 bg-white px-2 py-1 text-xs font-semibold text-slate-700 hover:bg-slate-50">Load Sample</button>  
                                    <button onclick="clearExpenseAudit()" class="rounded-md border border-slate-300 bg-white px-2 py-1 text-xs font-semibold text-slate-700 hover:bg-slate-50">Clear</button>  
                                </div>  
                            </div>  
                            <p class="text-xs text-slate-600">Paste one expense per line in the format: `Item $Amount`.</p>  
                            <textarea id="expense-input" class="w-full h-64 border rounded-xl p-4 text-sm mono bg-stone-50" placeholder="Adobe Creative Cloud $65&#10;Amazon Web Services $240&#10;Office Snacks $95&#10;Uber Rides $180"></textarea>  
                            <button id="btn-ai-audit" onclick="generateExpenseAudit()" class="w-full bg-gradient-to-r from-teal-600 to-cyan-700 text-white font-bold py-3 rounded-xl flex justify-center items-center gap-2 transition shadow">  
                                <span id="ai-audit-text">Run AI Expense Audit</span>  
                                <div id="ai-audit-loader" class="loading-spinner hidden"></div>  
                            </button>  
                            <p id="audit-status" class="text-xs text-slate-500">Ready. Add expenses and run analysis.</p>  
                        </div>

                        <div class="rounded-xl border border-slate-200 bg-white p-4">  
                            <p class="text-xs uppercase tracking-wide text-slate-500">Audit Snapshot</p>  
                            <div class="mt-3 grid grid-cols-3 gap-3">  
                                <div>  
                                    <p class="text-xs text-slate-500">Keep</p>  
                                    <p id="audit-kpi-keep" class="text-xl font-bold text-emerald-700">0</p>  
                                </div>  
                                <div>  
                                    <p class="text-xs text-slate-500">Cut</p>  
                                    <p id="audit-kpi-cut" class="text-xl font-bold text-rose-700">0</p>  
                                </div>  
                                <div>  
                                    <p class="text-xs text-slate-500">Review</p>  
                                    <p id="audit-kpi-review" class="text-xl font-bold text-amber-700">0</p>  
                                </div>  
                            </div>  
                            <p id="audit-kpi-note" class="mt-3 text-xs text-slate-600">No audit yet.</p>  
                        </div>  
                    </aside>

                    <section class="space-y-4 lg:col-span-7">  
                        <div id="audit-results" class="hidden space-y-4">  
                            <div class="flex items-center justify-between">  
                                <h4 class="font-bold text-stone-800">Audit Results</h4>  
                                <span class="rounded-full bg-slate-100 px-3 py-1 text-xs font-semibold text-slate-600">Prioritize `Cut` first</span>  
                            </div>  
                            <div id="audit-table-container" class="overflow-x-auto rounded-xl border border-stone-200">  
                                <table class="w-full text-left text-sm">  
                                    <thead class="bg-stone-100 text-stone-600 font-bold">  
                                        <tr>  
                                            <th class="p-3">Expense</th>  
                                            <th class="p-3">Action</th>  
                                            <th class="p-3">Reasoning</th>  
                                        </tr>  
                                    </thead>  
                                    <tbody id="audit-tbody" class="bg-white divide-y divide-stone-100"></tbody>  
                                </table>  
                            </div>  
                        </div>

                        <div id="audit-placeholder" class="h-full min-h-[340px] flex flex-col items-center justify-center rounded-xl border-2 border-dashed border-slate-300 bg-white/70 p-8 text-center text-slate-500">  
                            <span class="text-4xl" aria-hidden="true">&#128202;</span>  
                            <p class="mt-3 text-base font-semibold text-slate-700">No audit data yet</p>  
                            <p class="mt-1 max-w-md text-sm">Run the AI audit to see your categorized expense table with clear keep/cut/review guidance.</p>  
                        </div>
                    </section>  
                </div>  
            </div>  
              
            <div class="panel-shell p-6">  
                <div class="mb-4 flex flex-wrap items-start justify-between gap-3">  
                    <div>  
                        <h4 class="font-bold text-stone-800">Your 1% Quarterly Glide Path</h4>  
                        <p class="text-sm text-slate-600">A staged plan to increase Profit allocation while forcing healthier OpEx behavior.</p>  
                    </div>  
                    <span class="rounded-full border border-slate-200 bg-white px-3 py-1 text-xs font-semibold text-slate-600">8-phase projection</span>  
                </div>  
                <div class="chart-container">  
                    <canvas id="rolloutChart"></canvas>  
                </div>  
            </div>  
        </div>

        <!-- TAB 5: ✨ AI COACH -->  
        <div id="tab-coach" class="tab-panel hidden space-y-6">  
            <div class="panel-shell overflow-hidden">  
                <div class="border-b border-slate-200 bg-gradient-to-r from-teal-700 to-cyan-800 p-6 text-white">  
                    <div class="flex flex-wrap items-start justify-between gap-3">  
                        <div>  
                            <h3 class="text-2xl font-bold">AI Methodology Coach</h3>  
                            <p class="mt-1 text-sm text-cyan-100">Ask tactical questions and get guidance grounded in Profit First principles.</p>  
                        </div>  
                        <button onclick="clearCoachChat()" class="rounded-lg border border-cyan-200/60 bg-white/10 px-3 py-1.5 text-xs font-semibold text-white hover:bg-white/20">Clear Chat</button>  
                    </div>  
                    <div class="mt-4 flex flex-wrap gap-2">  
                        <button onclick="setCoachPrompt('What are the first 3 actions I should take this week to implement Profit First?')" class="rounded-full border border-cyan-200/60 bg-white/10 px-3 py-1 text-xs font-semibold text-cyan-50 hover:bg-white/20">First 3 actions</button>  
                        <button onclick="setCoachPrompt('How do I phase down OpEx without harming delivery quality?')" class="rounded-full border border-cyan-200/60 bg-white/10 px-3 py-1 text-xs font-semibold text-cyan-50 hover:bg-white/20">Reduce OpEx safely</button>  
                        <button onclick="setCoachPrompt('How do I handle tax reserves if my income is seasonal?')" class="rounded-full border border-cyan-200/60 bg-white/10 px-3 py-1 text-xs font-semibold text-cyan-50 hover:bg-white/20">Seasonal tax plan</button>  
                    </div>  
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-12">  
                    <aside class="border-b border-slate-200 bg-white p-4 lg:col-span-3 lg:border-b-0 lg:border-r">  
                        <p class="text-xs uppercase tracking-[0.16em] text-slate-500">Coach Scope</p>  
                        <ul class="mt-3 space-y-2 text-sm text-slate-600">  
                            <li class="rounded-lg border border-slate-200 bg-slate-50 px-3 py-2">Allocation sequence and cadence</li>  
                            <li class="rounded-lg border border-slate-200 bg-slate-50 px-3 py-2">CAP to TAP transition strategy</li>  
                            <li class="rounded-lg border border-slate-200 bg-slate-50 px-3 py-2">Owner pay and tax reserve discipline</li>  
                            <li class="rounded-lg border border-slate-200 bg-slate-50 px-3 py-2">Expense decisions and debt triage</li>  
                        </ul>  
                        <p id="coach-status" class="mt-4 text-xs text-slate-500">Ready to coach.</p>  
                    </aside>

                    <section class="bg-cyan-50/40 lg:col-span-9">  
                        <div id="chat-history" class="h-[460px] overflow-y-auto p-4 md:p-6 space-y-4">  
                            <div class="max-w-2xl rounded-2xl border border-emerald-200 bg-white px-4 py-3 text-sm text-stone-700 shadow-sm">  
                                Welcome. Ask a specific business scenario and I will respond with concise, actionable Profit First guidance.  
                            </div>  
                        </div>  
                        <div class="border-t border-slate-200 bg-white p-4">  
                            <div class="flex flex-col gap-2 sm:flex-row">  
                                <input type="text" id="chat-input" class="flex-grow border rounded-lg px-4 py-3" placeholder="Example: My OpEx is 68%. What 30-day correction plan should I run?">  
                                <button id="coach-send-btn" onclick="sendChatMessage()" class="bg-gradient-to-r from-teal-600 to-cyan-700 text-white px-6 py-3 rounded-lg font-bold transition shadow">Send</button>  
                            </div>  
                        </div>  
                    </section>  
                </div>  
            </div>  
        </div>

    </main>

    <footer class="mt-auto border-t border-slate-300/70 bg-[#fff9ef] py-8 text-slate-600">  
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">  
            <p class="text-sm">Profit First AI Dashboard &copy; <span id="current-year"></span></p>  
        </div>  
    </footer>

    <script>  
        // --- CONFIG & UTILS ---  
        async function geminiRequest(prompt, systemInstruction = "", isJson = false) {  
            const payload = { prompt, systemInstruction, isJson };

            for (let i = 0; i < 5; i++) {  
                try {  
                    const response = await fetch('/api/gemini', {  
                        method: 'POST',  
                        headers: { 'Content-Type': 'application/json' },  
                        body: JSON.stringify(payload)  
                    });  

                    if (!response.ok) {
                        const errorPayload = await response.json().catch(() => ({}));
                        throw new Error(errorPayload.error || 'API Error');
                    }

                    const data = await response.json();  
                    if (!data?.text) {
                        throw new Error('No response text received');
                    }
                    return data.text;  
                } catch (e) {
                    if (i === 4) {
                        throw e;
                    }
                    await new Promise(r => setTimeout(r, Math.pow(2, i) * 1000));  
                }  
            }  

            throw new Error('All retries failed');  
        }

        function parseModelJson(rawText) {
            const cleaned = String(rawText || '')
                .replace(/^```json\s*/i, '')
                .replace(/^```\s*/i, '')
                .replace(/\s*```$/i, '')
                .trim();

            try {
                return JSON.parse(cleaned);
            } catch {
                const start = cleaned.indexOf('{');
                const end = cleaned.lastIndexOf('}');
                if (start >= 0 && end > start) {
                    return JSON.parse(cleaned.slice(start, end + 1));
                }
                throw new Error('Unable to parse JSON response from model');
            }
        }

        function escapeHtml(value) {
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function updateCorePrinciplesDemo() {
            const revenueInput = document.getElementById('core-revenue-input');
            const profitSlider = document.getElementById('core-profit-slider');
            const pctLabel = document.getElementById('core-profit-pct');
            const profitAmount = document.getElementById('core-profit-amount');
            const opexAmount = document.getElementById('core-opex-amount');
            const savingsMsg = document.getElementById('core-savings-msg');

            if (!revenueInput || !profitSlider || !pctLabel || !profitAmount || !opexAmount || !savingsMsg) {
                return;
            }

            const revenue = Math.max(parseFloat(revenueInput.value) || 0, 0);
            const pct = Math.max(parseFloat(profitSlider.value) || 0, 0);
            const profit = revenue * (pct / 100);
            const opex = Math.max(revenue - profit, 0);

            pctLabel.innerText = `${pct}%`;
            profitAmount.innerText = formatCurrency(profit);
            opexAmount.innerText = formatCurrency(opex);
            savingsMsg.innerText = `Protect ${formatCurrency(profit)} first, leaving ${formatCurrency(opex)} for OpEx each month.`;
        }

        function setAssessmentTier(realRev) {
            const badge = document.getElementById('assessment-tier-badge');
            const note = document.getElementById('assessment-tier-note');
            if (!badge || !note) return;

            let tier = 'Starter';
            let noteText = 'Real Revenue below $250,000 maps to Starter TAP targets.';
            if (realRev > 500000) {
                tier = 'Scale';
                noteText = 'Real Revenue above $500,000 maps to Scale TAP targets.';
            } else if (realRev > 250000) {
                tier = 'Growth';
                noteText = 'Real Revenue between $250,000 and $500,000 maps to Growth TAP targets.';
            }

            badge.innerText = `Target Tier: ${tier}`;
            note.innerText = noteText;
        }

        function updateAssessmentSummary(caps, taps, realRev) {
            const kpiRevenue = document.getElementById('assessment-kpi-revenue');
            const kpiCapTotal = document.getElementById('assessment-kpi-cap-total');
            const kpiGap = document.getElementById('assessment-kpi-gap');
            if (!kpiRevenue || !kpiCapTotal || !kpiGap) return;

            kpiRevenue.innerText = formatCurrency(realRev);

            const totalCap = caps.profit + caps.owner + caps.tax + caps.opex;
            kpiCapTotal.innerText = `${totalCap}%`;

            if (realRev <= 0) {
                kpiGap.innerText = 'N/A';
                return;
            }

            const gaps = {
                profit: Math.max(taps.profit - caps.profit, 0),
                owner: Math.max(taps.owner - caps.owner, 0),
                tax: Math.max(taps.tax - caps.tax, 0),
                opex: Math.max(caps.opex - taps.opex, 0)
            };

            const labelMap = {
                profit: 'Profit',
                owner: 'Owner Pay',
                tax: 'Tax',
                opex: 'OpEx'
            };

            const biggest = Object.entries(gaps).sort((a, b) => b[1] - a[1])[0];
            if (!biggest || biggest[1] <= 0) {
                kpiGap.innerText = 'On target';
                return;
            }

            const [key, value] = biggest;
            if (key === 'opex') {
                kpiGap.innerText = `Reduce OpEx ${value}%`;
            } else {
                kpiGap.innerText = `${labelMap[key]} +${value}%`;
            }
        }

        function loadAssessmentSample() {
            document.getElementById('input-revenue').value = 480000;
            document.getElementById('input-materials').value = 90000;
            document.getElementById('input-profit').value = 12000;
            document.getElementById('input-pay').value = 128000;
            document.getElementById('input-tax').value = 45000;
            document.getElementById('input-opex').value = 205000;
            calculateAssessment();
        }

        function clearAssessmentInputs() {
            ['input-revenue', 'input-materials', 'input-profit', 'input-pay', 'input-tax', 'input-opex'].forEach((id) => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });

            const aiContainer = document.getElementById('ai-analysis-container');
            if (aiContainer) aiContainer.classList.add('hidden');
            calculateAssessment();
        }

        function loadExpenseSample() {
            const sample = [
                'Adobe Creative Cloud $65',
                'Amazon Web Services $240',
                'Notion Team Plan $48',
                'Office Snacks $95',
                'Uber Rides $180',
                'Contractor QA Support $420'
            ].join('\n');

            const input = document.getElementById('expense-input');
            const status = document.getElementById('audit-status');
            if (input) input.value = sample;
            if (status) status.innerText = 'Sample loaded. Run AI audit to generate recommendations.';
        }

        function updateAuditSummary(results) {
            const kKeep = document.getElementById('audit-kpi-keep');
            const kCut = document.getElementById('audit-kpi-cut');
            const kReview = document.getElementById('audit-kpi-review');
            const note = document.getElementById('audit-kpi-note');
            if (!kKeep || !kCut || !kReview || !note) return;

            const counts = { Keep: 0, Cut: 0, Review: 0 };
            results.forEach((r) => {
                if (r.action === 'Keep') counts.Keep += 1;
                else if (r.action === 'Cut') counts.Cut += 1;
                else counts.Review += 1;
            });

            kKeep.innerText = counts.Keep;
            kCut.innerText = counts.Cut;
            kReview.innerText = counts.Review;

            if (results.length === 0) {
                note.innerText = 'No audit yet.';
                return;
            }

            if (counts.Cut > 0) {
                note.innerText = `Start with ${counts.Cut} immediate cut item${counts.Cut > 1 ? 's' : ''}.`;
            } else if (counts.Review > 0) {
                note.innerText = `Prioritize ${counts.Review} review item${counts.Review > 1 ? 's' : ''} for replacement/renegotiation.`;
            } else {
                note.innerText = 'Most items are essential. Focus next on allocation discipline.';
            }
        }

        function clearExpenseAudit() {
            const input = document.getElementById('expense-input');
            const tbody = document.getElementById('audit-tbody');
            const results = document.getElementById('audit-results');
            const placeholder = document.getElementById('audit-placeholder');
            const status = document.getElementById('audit-status');

            if (input) input.value = '';
            if (tbody) tbody.innerHTML = '';
            if (results) results.classList.add('hidden');
            if (placeholder) placeholder.classList.remove('hidden');
            if (status) status.innerText = 'Ready. Add expenses and run analysis.';
            updateAuditSummary([]);
        }

        function setCoachPrompt(text) {
            const input = document.getElementById('chat-input');
            if (!input) return;
            input.value = text;
            input.focus();
        }

        function coachWelcomeMarkup() {
            return '<div class="max-w-2xl rounded-2xl border border-emerald-200 bg-white px-4 py-3 text-sm text-stone-700 shadow-sm">Welcome. Ask a specific business scenario and I will respond with concise, actionable Profit First guidance.</div>';
        }

        function clearCoachChat() {
            const history = document.getElementById('chat-history');
            const status = document.getElementById('coach-status');
            if (history) history.innerHTML = coachWelcomeMarkup();
            if (status) status.innerText = 'Ready to coach.';
        }

        // --- STATE ---  
        const state = {  
            currentTab: 'principles',  
            assessment: {  
                realRevenue: 0,  
                caps: { profit: 0, owner: 0, tax: 0, opex: 0 },  
                taps: { profit: 5, owner: 50, tax: 15, opex: 30 }  
            }  
        };

        let assessmentChartInstance = null;  
        let allocationDonutInstance = null;  
        let rolloutChartInstance = null;
        const TAB_IDS = ['principles', 'assessment', 'calculator', 'rollout', 'coach'];
        let tabTransitionInProgress = false;
        let tabTransitionHandle = null;

        function initTabArtifacts(tabId) {
            if (tabId === 'assessment' && !assessmentChartInstance) initAssessmentChart();
            if (tabId === 'calculator') {
                updateAllocationCalc();
                if (!allocationDonutInstance) initAllocationDonut();
            }
            if (tabId === 'rollout' && !rolloutChartInstance) initRolloutChart();
        }

        function setAtmosphereMood(tabId) {
            const moodMap = {
                principles: {
                    trendMain: 'rgba(15, 139, 141, 0.38)',
                    trendSoft: 'rgba(15, 139, 141, 0.2)',
                    trendAccent: 'rgba(10, 111, 113, 0.55)',
                    gridLine: 'rgba(16, 42, 67, 0.08)'
                },
                assessment: {
                    trendMain: 'rgba(37, 99, 235, 0.36)',
                    trendSoft: 'rgba(37, 99, 235, 0.18)',
                    trendAccent: 'rgba(29, 78, 216, 0.52)',
                    gridLine: 'rgba(30, 64, 175, 0.08)'
                },
                calculator: {
                    trendMain: 'rgba(22, 163, 74, 0.36)',
                    trendSoft: 'rgba(22, 163, 74, 0.2)',
                    trendAccent: 'rgba(21, 128, 61, 0.53)',
                    gridLine: 'rgba(21, 128, 61, 0.08)'
                },
                rollout: {
                    trendMain: 'rgba(8, 145, 178, 0.37)',
                    trendSoft: 'rgba(8, 145, 178, 0.2)',
                    trendAccent: 'rgba(14, 116, 144, 0.55)',
                    gridLine: 'rgba(8, 145, 178, 0.08)'
                },
                coach: {
                    trendMain: 'rgba(14, 116, 144, 0.36)',
                    trendSoft: 'rgba(14, 116, 144, 0.18)',
                    trendAccent: 'rgba(14, 116, 144, 0.54)',
                    gridLine: 'rgba(14, 116, 144, 0.08)'
                }
            };

            const mood = moodMap[tabId] || moodMap.principles;
            const root = document.documentElement;
            root.style.setProperty('--trend-main', mood.trendMain);
            root.style.setProperty('--trend-soft', mood.trendSoft);
            root.style.setProperty('--trend-accent', mood.trendAccent);
            root.style.setProperty('--grid-line', mood.gridLine);
        }

        function animateTabUnits(section) {
            if (!section) return;
            const nodes = Array.from(section.querySelectorAll('.panel-shell, .sub-panel, .rounded-xl, .chart-container'));
            const uniqueNodes = [];
            nodes.forEach((node) => {
                if (!uniqueNodes.includes(node)) uniqueNodes.push(node);
            });

            uniqueNodes.slice(0, 18).forEach((node) => {
                node.classList.remove('motion-seed');
                node.style.animationDelay = '0ms';
            });
            void section.offsetWidth;
            uniqueNodes.slice(0, 18).forEach((node, index) => {
                node.style.animationDelay = `${Math.min(index * 45, 420)}ms`;
                node.classList.add('motion-seed');
            });
        }

        function switchTab(tabId) {  
            if (!TAB_IDS.includes(tabId)) return;

            const mobileMenu = document.getElementById('mobile-menu');
            if (mobileMenu) mobileMenu.classList.add('hidden');

            const nextSection = document.getElementById(`tab-${tabId}`);
            const currentSection = document.getElementById(`tab-${state.currentTab}`);
            if (!nextSection) return;

            if (tabTransitionInProgress) return;
            if (tabId === state.currentTab && !nextSection.classList.contains('hidden')) return;

            TAB_IDS.forEach((t) => {
                const btn = document.getElementById(`nav-${t}`);
                if (!btn) return;
                if (t === tabId) {
                    btn.classList.add('active-tab');
                    btn.classList.remove('inactive-tab');
                } else {
                    btn.classList.remove('active-tab');
                    btn.classList.add('inactive-tab');
                }
            });

            tabTransitionInProgress = true;
            setAtmosphereMood(tabId);
            state.currentTab = tabId;

            const revealNext = () => {
                nextSection.classList.remove('hidden', 'tab-panel-out');
                nextSection.classList.remove('tab-panel-in');
                void nextSection.offsetWidth;
                nextSection.classList.add('tab-panel-in');

                initTabArtifacts(tabId);
                animateTabUnits(nextSection);

                if (tabTransitionHandle) clearTimeout(tabTransitionHandle);
                tabTransitionHandle = setTimeout(() => {
                    nextSection.classList.remove('tab-panel-in');
                    tabTransitionInProgress = false;
                }, 540);
            };

            if (currentSection && currentSection !== nextSection && !currentSection.classList.contains('hidden')) {
                currentSection.classList.remove('tab-panel-in');
                currentSection.classList.add('tab-panel-out');
                setTimeout(() => {
                    currentSection.classList.add('hidden');
                    currentSection.classList.remove('tab-panel-out');
                    revealNext();
                }, 220);
            } else {
                revealNext();
            }
        }

        // --- AI FEATURES ---

        async function generateAIHealthAnalysis() {  
            if (state.assessment.realRevenue <= 0) {
                const hint = document.getElementById('assessment-ai-hint');
                if (hint) hint.innerText = 'Enter revenue first to enable AI analysis.';
                return;
            }
              
            const btn = document.getElementById('btn-ai-analyze');  
            const text = document.getElementById('ai-analyze-text');  
            const loader = document.getElementById('ai-analyze-loader');  
            const container = document.getElementById('ai-analysis-container');  
            const content = document.getElementById('ai-analysis-content');
            const hint = document.getElementById('assessment-ai-hint');

            btn.disabled = true;  
            text.innerText = "Analyzing...";  
            loader.classList.remove('hidden');
            if (hint) hint.innerText = 'Analyzing your current CAPs vs TAPs snapshot...';

            const prompt = `Based on these Profit First numbers:  
            Real Revenue: ${state.assessment.realRevenue}  
            Actuals (CAPs): Profit ${state.assessment.caps.profit}%, Owner Pay ${state.assessment.caps.owner}%, Tax ${state.assessment.caps.tax}%, OpEx ${state.assessment.caps.opex}%  
            Targets (TAPs): Profit ${state.assessment.taps.profit}%, Owner Pay ${state.assessment.taps.owner}%, Tax ${state.assessment.taps.tax}%, OpEx ${state.assessment.taps.opex}%  
            Provide 3 specific, encouraging, yet firm actionable steps to improve financial health. Keep it under 150 words.`;

            try {  
                const result = await geminiRequest(prompt, "You are an expert Profit First Certified Professional. Be encouraging and strategic.");  
                content.innerText = result;  
                container.classList.remove('hidden');  
                if (hint) hint.innerText = 'AI brief generated from your current data.';
            } catch (err) {  
                content.innerText = `AI request failed: ${err?.message || 'Unknown error. Please try again.'}`;  
                container.classList.remove('hidden');  
                if (hint) hint.innerText = 'Review the error details above.';
            } finally {  
                btn.disabled = false;  
                text.innerText = "Get AI Analysis";  
                loader.classList.add('hidden');  
            }  
        }

        async function generateExpenseAudit() {  
            const rawText = document.getElementById('expense-input').value;  
            const status = document.getElementById('audit-status');
            if (!rawText.trim()) {
                if (status) status.innerText = 'Add at least one expense line before running the audit.';
                return;
            }

            const btn = document.getElementById('btn-ai-audit');  
            const text = document.getElementById('ai-audit-text');  
            const loader = document.getElementById('ai-audit-loader');  
            const results = document.getElementById('audit-results');  
            const placeholder = document.getElementById('audit-placeholder');  
            const tbody = document.getElementById('audit-tbody');

            btn.disabled = true;  
            text.innerText = "Auditing...";  
            loader.classList.remove('hidden');
            if (status) status.innerText = 'Analyzing expense list and categorizing actions...';

            const system = "You are an efficiency expert. Categorize expenses into 'Keep' (essential for production), 'Cut' (non-essential, luxury, or redundant), or 'Review' (can be replaced with cheaper alternative). Return JSON: { results: [{ item, action, why }] }";  
              
            try {  
                const response = await geminiRequest(`Audit these expenses: ${rawText}`, system, true);  
                const data = parseModelJson(response);
                if (!Array.isArray(data.results)) {
                    throw new Error('Invalid audit response');
                }

                const normalized = data.results.map((r) => {
                    let action = String(r.action || 'Review').trim();
                    action = action.toLowerCase();
                    if (action === 'keep') action = 'Keep';
                    else if (action === 'cut') action = 'Cut';
                    else action = 'Review';
                    return {
                        item: String(r.item || 'Unspecified item'),
                        action,
                        why: String(r.why || 'No explanation provided.')
                    };
                });
                  
                tbody.innerHTML = normalized.map(r => `  
                    <tr>  
                        <td class="p-3 font-medium text-stone-800">${escapeHtml(r.item)}</td>  
                        <td class="p-3">  
                            <span class="px-2 py-1 rounded-full text-xs font-bold ${  
                                r.action === 'Keep' ? 'bg-green-100 text-green-700' :   
                                r.action === 'Cut' ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700'  
                            }">${escapeHtml(r.action)}</span>  
                        </td>  
                        <td class="p-3 text-stone-500 italic">${escapeHtml(r.why)}</td>  
                    </tr>  
                `).join('');

                placeholder.classList.add('hidden');  
                results.classList.remove('hidden');  
                updateAuditSummary(normalized);
                if (status) status.innerText = `Audit complete. ${normalized.length} expense item${normalized.length > 1 ? 's' : ''} analyzed.`;
            } catch (err) {  
                if (status) status.innerText = `Audit failed: ${err?.message || 'Unknown error'}. Try a smaller or cleaner list.`;
            } finally {  
                btn.disabled = false;  
                text.innerText = "Run AI Expense Audit";  
                loader.classList.add('hidden');  
            }  
        }

        async function sendChatMessage() {  
            const input = document.getElementById('chat-input');  
            const history = document.getElementById('chat-history');  
            const status = document.getElementById('coach-status');
            const sendBtn = document.getElementById('coach-send-btn');
            const query = input.value.trim();  
            if (!query) return;

            const userDiv = document.createElement('div');  
            userDiv.className = "ml-auto max-w-2xl rounded-2xl border border-cyan-200 bg-cyan-100 px-4 py-3 text-sm text-cyan-900 shadow-sm";  
            userDiv.innerText = query;  
            history.appendChild(userDiv);  
            input.value = "";

            const loadingDiv = document.createElement('div');  
            loadingDiv.className = "max-w-2xl rounded-2xl border border-stone-200 bg-white px-4 py-3 text-sm text-stone-400 italic shadow-sm";  
            loadingDiv.innerText = "Coach is thinking...";  
            history.appendChild(loadingDiv);  
            history.scrollTop = history.scrollHeight;
            if (status) status.innerText = 'Generating response...';
            if (sendBtn) sendBtn.disabled = true;

            try {  
                const response = await geminiRequest(query, "You are a Profit First methodology coach. Only answer based on the books Profit First, Clockwork, or Fix This Next by Mike Michalowicz. Keep answers practical and concise with numbered steps when applicable.");  
                loadingDiv.innerText = response;  
                loadingDiv.classList.remove('text-stone-400', 'italic');  
                loadingDiv.classList.add('text-stone-600');  
                if (status) status.innerText = 'Response ready.';
            } catch (e) {  
                loadingDiv.innerText = "The connection to the methodology vault was lost.";  
                if (status) status.innerText = 'Connection issue. Please retry.';
            }  
            if (sendBtn) sendBtn.disabled = false;
            history.scrollTop = history.scrollHeight;  
        }

        // --- CORE LOGIC (CALCS & CHARTS) ---

        function calculateAssessment() {  
            const rev = parseFloat(document.getElementById('input-revenue').value) || 0;  
            const mat = parseFloat(document.getElementById('input-materials').value) || 0;  
            const realRev = rev - mat;  
            document.getElementById('display-real-revenue').innerText = formatCurrency(realRev);  
            state.assessment.realRevenue = realRev;

            let taps = { profit: 5, owner: 50, tax: 15, opex: 30 };  
            if (realRev > 250000) taps = { profit: 10, owner: 35, tax: 15, opex: 40 };  
            if (realRev > 500000) taps = { profit: 15, owner: 20, tax: 15, opex: 50 };  
            state.assessment.taps = taps;
            setAssessmentTier(realRev);

            const profitVal = parseFloat(document.getElementById('input-profit').value) || 0;  
            const payVal = parseFloat(document.getElementById('input-pay').value) || 0;  
            const taxVal = parseFloat(document.getElementById('input-tax').value) || 0;  
            const opexVal = parseFloat(document.getElementById('input-opex').value) || 0;  
            const calcBase = realRev > 0 ? realRev : 1;

            state.assessment.caps = {  
                profit: Math.round((profitVal / calcBase) * 100),  
                owner: Math.round((payVal / calcBase) * 100),  
                tax: Math.round((taxVal / calcBase) * 100),  
                opex: Math.round((opexVal / calcBase) * 100)  
            };

            if (assessmentChartInstance) {  
                assessmentChartInstance.data.datasets[0].data = [state.assessment.caps.profit, state.assessment.caps.owner, state.assessment.caps.tax, state.assessment.caps.opex];  
                assessmentChartInstance.data.datasets[1].data = [taps.profit, taps.owner, taps.tax, taps.opex];  
                assessmentChartInstance.update();  
            }  
            updateAssessmentFeedback(state.assessment.caps, taps);  
            updateAssessmentSummary(state.assessment.caps, taps, realRev);

            const aiBtn = document.getElementById('btn-ai-analyze');
            const aiHint = document.getElementById('assessment-ai-hint');
            if (aiBtn) aiBtn.disabled = realRev <= 0;
            if (aiHint) {
                aiHint.innerText = realRev > 0
                    ? 'Ready. Click to generate AI strategy analysis.'
                    : 'Enter revenue first to enable AI analysis.';
            }
        }

        function updateAssessmentFeedback(caps, taps) {  
            const container = document.getElementById('assessment-feedback');  
            container.innerHTML = '';  
            if (state.assessment.realRevenue <= 0) {
                container.innerHTML = '<div class="p-4 bg-white border border-stone-200 rounded-lg shadow-sm"><h4 class="font-bold text-stone-700">Enter your numbers to generate diagnosis cards.</h4></div>';
                return;
            }
            const labelMap = { profit: 'Profit', owner: 'Owner Pay', tax: 'Tax', opex: 'OpEx' };

            Object.keys(taps).forEach(key => {  
                const diff = caps[key] - taps[key];  
                const label = labelMap[key];
                let msg = '';
                let color = '';

                if (key === 'opex') {
                    if (diff <= 0) {
                        msg = `On target. Keep OpEx at or below ${taps[key]}%.`;
                        color = 'border-green-400 bg-green-50';
                    } else {
                        msg = `Reduce OpEx by ${diff}% and redirect to Profit/Tax over the next 2 allocation cycles.`;
                        color = 'border-amber-400 bg-amber-50';
                    }
                } else {
                    if (diff >= 0) {
                        msg = `At target${diff > 0 ? ` (+${diff}%)` : ''}. Maintain this discipline.`;
                        color = 'border-green-400 bg-green-50';
                    } else {
                        msg = `Increase ${label} by ${Math.abs(diff)}% by reallocating from OpEx in phased steps.`;
                        color = 'border-amber-400 bg-amber-50';
                    }
                }

                container.innerHTML += `<div class="p-4 rounded-lg border-l-4 shadow-sm ${color}"><h4 class="font-bold">${label}</h4><p class="text-xs">${msg}</p></div>`;  
            });  
        }

        function setAllocationIncome(value) {
            document.getElementById('calc-income').value = value;
            updateAllocationCalc();
        }

        function setAllocationPreset(preset) {
            const profiles = {
                starter: { profit: 5, owner: 50, tax: 15 },
                growth: { profit: 10, owner: 45, tax: 15 },
                scale: { profit: 15, owner: 30, tax: 20 }
            };
            const config = profiles[preset] || profiles.starter;
            document.getElementById('slider-profit').value = config.profit;
            document.getElementById('slider-comp').value = config.owner;
            document.getElementById('slider-tax').value = config.tax;
            updateAllocationCalc();
        }

        function updateAllocationCalc(changedSliderId = null) {  
            const income = parseFloat(document.getElementById('calc-income').value) || 0;  

            let pPct = parseInt(document.getElementById('slider-profit').value) || 0;  
            let cPct = parseInt(document.getElementById('slider-comp').value) || 0;  
            let tPct = parseInt(document.getElementById('slider-tax').value) || 0;  

            const totalBeforeClamp = pPct + cPct + tPct;
            if (changedSliderId && totalBeforeClamp > 100) {
                const overflow = totalBeforeClamp - 100;
                const slider = document.getElementById(changedSliderId);
                const adjusted = Math.max(0, (parseInt(slider.value) || 0) - overflow);
                slider.value = adjusted;
                pPct = parseInt(document.getElementById('slider-profit').value) || 0;
                cPct = parseInt(document.getElementById('slider-comp').value) || 0;
                tPct = parseInt(document.getElementById('slider-tax').value) || 0;
            }

            const allocatedPct = pPct + cPct + tPct;
            const oPct = Math.max(0, 100 - allocatedPct);

            const profitAmt = income * (pPct / 100);
            const compAmt = income * (cPct / 100);
            const taxAmt = income * (tPct / 100);
            const opexAmt = income * (oPct / 100);

            document.getElementById('val-profit-pct').innerText = pPct + "%";  
            document.getElementById('val-comp-pct').innerText = cPct + "%";  
            document.getElementById('val-tax-pct').innerText = tPct + "%";
            document.getElementById('out-total-allocated').innerText = allocatedPct + "%";
            document.getElementById('out-opex-pct').innerText = oPct + "%";

            document.getElementById('out-profit').innerText = formatCurrency(profitAmt);  
            document.getElementById('out-comp').innerText = formatCurrency(compAmt);
            document.getElementById('out-tax').innerText = formatCurrency(taxAmt);
            document.getElementById('out-opex').innerText = formatCurrency(opexAmt);

            document.getElementById('check-profit-amt').innerText = formatCurrency(profitAmt);
            document.getElementById('check-comp-amt').innerText = formatCurrency(compAmt);
            document.getElementById('check-tax-amt').innerText = formatCurrency(taxAmt);
            document.getElementById('check-opex-amt').innerText = formatCurrency(opexAmt);

            document.getElementById('bar-opex').style.width = oPct + "%";

            const healthBadge = document.getElementById('allocation-health');
            const healthNote = document.getElementById('allocation-health-note');
            if (oPct >= 45) {
                healthBadge.className = "mt-3 inline-flex rounded-full bg-amber-100 px-2.5 py-1 text-xs font-bold text-amber-700";
                healthBadge.innerText = "OpEx Heavy";
                healthNote.innerText = "Consider nudging 1-3% from OpEx into Profit or Tax over the next cycles.";
            } else if (oPct >= 30) {
                healthBadge.className = "mt-3 inline-flex rounded-full bg-emerald-100 px-2.5 py-1 text-xs font-bold text-emerald-700";
                healthBadge.innerText = "Balanced Mix";
                healthNote.innerText = "You are preserving enough room for operational capacity.";
            } else {
                healthBadge.className = "mt-3 inline-flex rounded-full bg-cyan-100 px-2.5 py-1 text-xs font-bold text-cyan-700";
                healthBadge.innerText = "Lean Mode";
                healthNote.innerText = "Strong cash discipline. Confirm this OpEx level is sustainable operationally.";
            }

            if (allocationDonutInstance) {  
                allocationDonutInstance.data.datasets[0].data = [pPct, cPct, tPct, oPct];  
                allocationDonutInstance.update();  
            }  
        }

        function formatCurrency(num) { return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(num); }

        function initAssessmentChart() {  
            const ctx = document.getElementById('assessmentChart').getContext('2d');  
            assessmentChartInstance = new Chart(ctx, {  
                type: 'bar',  
                data: {  
                    labels: ['Profit', 'Owner Pay', 'Tax', 'OpEx'],  
                    datasets: [  
                        { label: 'Current (CAPs)', data: [0, 0, 0, 0], backgroundColor: '#A8A29E', borderRadius: 4 },  
                        { label: 'Target (TAPs)', data: [5, 50, 15, 30], backgroundColor: ['#10B981', '#3B82F6', '#F59E0B', '#64748B'], borderRadius: 4 }  
                    ]  
                },  
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { boxWidth: 12, boxHeight: 12 }
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => `${context.dataset.label}: ${context.raw}%`
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { callback: (value) => `${value}%` }
                        }
                    }
                }  
            });  
        }

        function initAllocationDonut() {  
            const ctx = document.getElementById('allocationDonut').getContext('2d');  
            allocationDonutInstance = new Chart(ctx, {  
                type: 'doughnut',  
                data: {  
                    labels: ['Profit', 'Owner Pay', 'Tax', 'OpEx'],  
                    datasets: [{
                        data: [5, 50, 15, 30],
                        backgroundColor: ['#16a34a', '#2563eb', '#d97706', '#475569'],
                        borderColor: '#f8f4ea',
                        borderWidth: 4
                    }]  
                },  
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '68%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { boxWidth: 12, boxHeight: 12, usePointStyle: true, pointStyle: 'circle' }
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const income = parseFloat(document.getElementById('calc-income').value) || 0;
                                    const pct = context.raw || 0;
                                    const amt = formatCurrency(income * (pct / 100));
                                    return `${context.label}: ${pct}% (${amt})`;
                                }
                            }
                        }
                    }
                }  
            });  
        }

        function initRolloutChart() {  
            const ctx = document.getElementById('rolloutChart').getContext('2d');  
            rolloutChartInstance = new Chart(ctx, {  
                type: 'line',  
                data: {  
                    labels: ['Start', 'Q1', 'Q2', 'Q3', 'Q4', 'Q5', 'Q6', 'Target'],  
                    datasets: [  
                        { label: 'Profit %', data: [1, 2, 3, 4, 6, 8, 11, 15], borderColor: '#10B981', tension: 0.3 },  
                        { label: 'OpEx %', data: [80, 77, 74, 70, 65, 60, 55, 50], borderColor: '#64748B', borderDash: [5, 5], tension: 0.3 }  
                    ]  
                },  
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { boxWidth: 12, boxHeight: 12 }
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => `${context.dataset.label}: ${context.raw}%`
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { callback: (value) => `${value}%` }
                        }
                    }
                }  
            });  
        }

        Chart.defaults.color = '#334e68';
        Chart.defaults.font.family = 'Source Sans 3';

        document.getElementById('chat-input').addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                sendChatMessage();
            }
        });

        document.getElementById('current-year').innerText = new Date().getFullYear();
        updateCorePrinciplesDemo();
        calculateAssessment();
        updateAuditSummary([]);
        updateAllocationCalc();
        setAtmosphereMood(state.currentTab);
        requestAnimationFrame(() => {
            document.body.classList.add('app-ready');
            animateTabUnits(document.getElementById('tab-principles'));
        });
        setTimeout(() => {
            const firstTab = document.getElementById('tab-principles');
            if (firstTab) firstTab.classList.remove('tab-panel-in');
        }, 560);

    </script>  
</body>  
</html>  


