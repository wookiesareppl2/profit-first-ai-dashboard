<!DOCTYPE html>  
<html lang="en">  
<head>  
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  
    <title>Profit First: Interactive Business Guide</title>  
    <!-- Tailwind CSS -->  
    <script src="https://cdn.tailwindcss.com"></script>  
    <!-- Chart.js -->  
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>  
    <!-- Google Fonts -->  
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <!-- Chosen Palette: Warm Neutrals & Financial Clarity -->  
    <style>  
        body {  
            font-family: 'Inter', sans-serif;  
            background-color: #FAFAF9; /* stone-50 */  
            color: #1C1917; /* stone-900 */  
        }  
        .chart-container {  
            position: relative;  
            width: 100%;  
            max-width: 600px;  
            margin-left: auto;  
            margin-right: auto;  
            height: 300px;  
            max-height: 400px;  
        }  
        @media (min-width: 768px) {  
            .chart-container {  
                height: 350px;  
            }  
        }  
        .active-tab {  
            border-bottom: 3px solid #10B981;  
            color: #10B981;  
            font-weight: 600;  
        }  
        .inactive-tab {  
            border-bottom: 3px solid transparent;  
            color: #78716C;  
            font-weight: 400;  
        }  
        .inactive-tab:hover {  
            color: #1C1917;  
            border-bottom: 3px solid #E7E5E4;  
        }  
        input[type=range] {  
            -webkit-appearance: none;   
            background: transparent;   
        }  
        input[type=range]::-webkit-slider-thumb {  
            -webkit-appearance: none;  
            height: 20px;  
            width: 20px;  
            border-radius: 50%;  
            background: #10B981;  
            cursor: pointer;  
            margin-top: -8px;   
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);  
        }  
        input[type=range]::-webkit-slider-runnable-track {  
            width: 100%;  
            height: 4px;  
            cursor: pointer;  
            background: #D6D3D1;  
            border-radius: 2px;  
        }  
        .loading-spinner {  
            border: 3px solid #f3f3f3;  
            border-top: 3px solid #10B981;  
            border-radius: 50%;  
            width: 20px;  
            height: 20px;  
            animation: spin 1s linear infinite;  
            display: inline-block;  
        }  
        @keyframes spin {  
            0% { transform: rotate(0deg); }  
            100% { transform: rotate(360deg); }  
        }  
    </style>  
    <!-- Application Structure Plan:  
         1. Header: Simple branding and Introduction to the core philosophy.  
         2. Tabbed Navigation:   
            - Tab 1: Principles - Educational context.  
            - Tab 2: Assessment - Health check + ✨ AI Analysis.  
            - Tab 3: Allocation Tool - Real-time calculator.  
            - Tab 4: Strategy & Optimizer - ✨ AI Expense Auditor + Rollout plan.  
            - Tab 5: AI Coach - ✨ Methodology Q&A.  
         3. AI Integration: Uses Gemini 2.5 Flash to provide personalized financial insights and categorize messy expense data.  
    -->  
</head>  
<body class="flex flex-col min-h-screen">

    <!-- Navigation / Header -->  
    <header class="bg-white shadow-sm sticky top-0 z-50">  
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">  
            <div class="flex justify-between items-center py-4">  
                <div class="flex items-center space-x-2">  
                    <span class="text-2xl text-emerald-500 font-bold">&#128176;</span>  
                    <h1 class="text-xl font-bold tracking-tight text-stone-800">Profit First <span class="font-light text-stone-500">AI Assistant</span></h1>  
                </div>  
                <nav class="hidden md:flex space-x-8">  
                    <button onclick="switchTab('principles')" id="nav-principles" class="active-tab py-2 px-1 text-sm transition-colors">Core Principles</button>  
                    <button onclick="switchTab('assessment')" id="nav-assessment" class="inactive-tab py-2 px-1 text-sm transition-colors">Instant Assessment</button>  
                    <button onclick="switchTab('calculator')" id="nav-calculator" class="inactive-tab py-2 px-1 text-sm transition-colors">Allocation Tool</button>  
                    <button onclick="switchTab('rollout')" id="nav-rollout" class="inactive-tab py-2 px-1 text-sm transition-colors">Strategy Optimizer</button>  
                    <button onclick="switchTab('coach')" id="nav-coach" class="inactive-tab py-2 px-1 text-sm transition-colors">✨ AI Coach</button>  
                </nav>  
                <button class="md:hidden text-stone-500" onclick="document.getElementById('mobile-menu').classList.toggle('hidden')">  
                    &#9776;  
                </button>  
            </div>  
            <div id="mobile-menu" class="hidden md:hidden pb-4">  
                <div class="flex flex-col space-y-2">  
                    <button onclick="switchTab('principles')" class="text-left px-3 py-2 rounded-md hover:bg-stone-100">Core Principles</button>  
                    <button onclick="switchTab('assessment')" class="text-left px-3 py-2 rounded-md hover:bg-stone-100">Instant Assessment</button>  
                    <button onclick="switchTab('calculator')" class="text-left px-3 py-2 rounded-md hover:bg-stone-100">Allocation Tool</button>  
                    <button onclick="switchTab('rollout')" class="text-left px-3 py-2 rounded-md hover:bg-stone-100">Strategy Optimizer</button>  
                    <button onclick="switchTab('coach')" class="text-left px-3 py-2 rounded-md hover:bg-stone-100">✨ AI Coach</button>  
                </div>  
            </div>  
        </div>  
    </header>

    <!-- Main Content Area -->  
    <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full">

        <!-- TAB 1: CORE PRINCIPLES -->  
        <div id="tab-principles" class="space-y-12 animate-fade-in">  
            <div class="bg-white rounded-2xl p-8 shadow-sm border border-stone-100 text-center">  
                <h2 class="text-3xl font-bold text-stone-800 mb-4">Flip the Formula</h2>  
                <p class="text-lg text-stone-600 max-w-3xl mx-auto mb-8">  
                    Humans eat what is on their plate. If the plate is smaller, we eat less.   
                </p>  
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center justify-center max-w-4xl mx-auto">  
                    <div class="p-6 rounded-xl bg-stone-50 border border-stone-200 opacity-60">  
                        <h3 class="text-sm uppercase tracking-wide text-stone-500 mb-2">The Old Way</h3>  
                        <div class="text-xl md:text-2xl font-mono text-stone-700">Sales - Expenses = <span class="text-stone-400">Profit?</span></div>  
                    </div>  
                    <div class="p-6 rounded-xl bg-emerald-50 border-2 border-emerald-100 shadow-md transform scale-105">  
                        <h3 class="text-sm uppercase tracking-wide text-emerald-600 mb-2 font-bold">The Profit First Way</h3>  
                        <div class="text-xl md:text-2xl font-mono text-stone-800 font-bold">Sales - <span class="text-emerald-600">Profit</span> = Expenses</div>  
                    </div>  
                </div>  
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4">  
                <div class="bg-white p-6 rounded-xl shadow-sm border-t-4 border-stone-800 hover:shadow-md transition">  
                    <div class="text-3xl mb-2">&#128181;</div>  
                    <h4 class="font-bold text-stone-800">1. Income</h4>  
                    <p class="text-xs text-stone-500 mt-2">The serving tray. $0 balance after allocations.</p>  
                </div>  
                <div class="bg-white p-6 rounded-xl shadow-sm border-t-4 border-emerald-500 hover:shadow-md transition">  
                    <div class="text-3xl mb-2">&#127873;</div>  
                    <h4 class="font-bold text-stone-800">2. Profit</h4>  
                    <p class="text-xs text-stone-500 mt-2">Quarterly distributions and rainy day fund.</p>  
                </div>  
                <div class="bg-white p-6 rounded-xl shadow-sm border-t-4 border-blue-500 hover:shadow-md transition">  
                    <div class="text-3xl mb-2">&#128100;</div>  
                    <h4 class="font-bold text-stone-800">3. Owner Comp</h4>  
                    <p class="text-xs text-stone-500 mt-2">Your salary for working in the business.</p>  
                </div>  
                <div class="bg-white p-6 rounded-xl shadow-sm border-t-4 border-amber-500 hover:shadow-md transition">  
                    <div class="text-3xl mb-2">&#127963;</div>  
                    <h4 class="font-bold text-stone-800">4. Tax</h4>  
                    <p class="text-xs text-stone-500 mt-2">Pay your tax liabilities from here.</p>  
                </div>  
                <div class="bg-white p-6 rounded-xl shadow-sm border-t-4 border-slate-500 hover:shadow-md transition">  
                    <div class="text-3xl mb-2">&#128736;</div>  
                    <h4 class="font-bold text-stone-800">5. OpEx</h4>  
                    <p class="text-xs text-stone-500 mt-2">Run the business on this remainder.</p>  
                </div>  
            </div>  
        </div>

        <!-- TAB 2: INSTANT ASSESSMENT -->  
        <div id="tab-assessment" class="hidden space-y-8">  
            <div class="bg-white rounded-2xl p-8 shadow-sm border border-stone-100">  
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-12">  
                    <div class="space-y-6 lg:col-span-1">  
                        <h3 class="font-bold text-stone-800 border-b pb-2">1. Enter Data</h3>  
                        <div class="space-y-4">  
                            <div>  
                                <label class="block text-sm font-medium text-stone-700">Total Top Line Revenue</label>  
                                <input type="number" id="input-revenue" class="mt-1 block w-full border border-stone-300 rounded-md p-2" oninput="calculateAssessment()">  
                            </div>  
                            <div>  
                                <label class="block text-sm font-medium text-stone-700">Materials & Subs</label>  
                                <input type="number" id="input-materials" class="mt-1 block w-full border border-stone-300 rounded-md p-2" oninput="calculateAssessment()">  
                            </div>  
                            <div class="p-4 bg-emerald-50 rounded-lg">  
                                <label class="text-sm font-bold text-emerald-800">Real Revenue:</label>  
                                <div id="display-real-revenue" class="text-2xl font-bold text-emerald-700">$0.00</div>  
                            </div>  
                        </div>  
                        <div class="space-y-4 pt-4 border-t">  
                            <h4 class="font-medium text-stone-900">Current Actuals ($)</h4>  
                            <input type="number" id="input-profit" placeholder="Profit Distribution" class="w-full border p-2 rounded" oninput="calculateAssessment()">  
                            <input type="number" id="input-pay" placeholder="Owner's Pay" class="w-full border p-2 rounded" oninput="calculateAssessment()">  
                            <input type="number" id="input-tax" placeholder="Tax Paid" class="w-full border p-2 rounded" oninput="calculateAssessment()">  
                            <input type="number" id="input-opex" placeholder="Operating Expenses" class="w-full border p-2 rounded" oninput="calculateAssessment()">  
                        </div>  
                    </div>

                    <div class="lg:col-span-2 space-y-6">  
                        <div class="flex justify-between items-center">  
                            <h3 class="font-bold text-stone-800 border-b pb-2">2. Diagnosis & ✨ AI Insight</h3>  
                            <button id="btn-ai-analyze" onclick="generateAIHealthAnalysis()" class="bg-stone-800 hover:bg-black text-white px-4 py-2 rounded-lg text-sm flex items-center gap-2 transition disabled:opacity-50">  
                                <span id="ai-analyze-text">✨ Get AI Analysis</span>  
                                <div id="ai-analyze-loader" class="loading-spinner hidden"></div>  
                            </button>  
                        </div>  
                          
                        <div class="bg-stone-50 p-4 rounded-xl border border-stone-200">  
                            <div class="chart-container">  
                                <canvas id="assessmentChart"></canvas>  
                            </div>  
                        </div>

                        <div id="ai-analysis-container" class="hidden p-6 bg-emerald-50 border border-emerald-200 rounded-xl space-y-4">  
                            <h4 class="font-bold text-emerald-800 flex items-center gap-2">✨ Personalized Strategy Analysis</h4>  
                            <div id="ai-analysis-content" class="text-stone-700 text-sm leading-relaxed whitespace-pre-line"></div>  
                        </div>

                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4" id="assessment-feedback">  
                            <div class="p-4 bg-white border border-stone-200 rounded-lg shadow-sm">  
                                <h4 class="font-bold text-stone-700">Enter data to see your diagnosis.</h4>  
                            </div>  
                        </div>  
                    </div>  
                </div>  
            </div>  
        </div>

        <!-- TAB 3: ALLOCATION CALCULATOR -->  
        <div id="tab-calculator" class="hidden space-y-8">  
            <div class="bg-white rounded-2xl p-8 shadow-sm border border-stone-100">  
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">  
                    <div class="lg:col-span-5 space-y-6 bg-stone-50 p-6 rounded-xl">  
                        <div>  
                            <label class="block text-lg font-bold text-stone-800 mb-2">Current Income Balance</label>  
                            <input type="number" id="calc-income" class="w-full border p-3 rounded-md text-lg" value="10000" oninput="updateAllocationCalc()">  
                        </div>  
                        <div class="space-y-4">  
                            <div class="flex justify-between"><label class="text-sm font-medium">Profit (%)</label><span id="val-profit-pct">5%</span></div>  
                            <input type="range" id="slider-profit" min="0" max="50" value="5" class="w-full" oninput="updateAllocationCalc()">  
                            <div class="flex justify-between"><label class="text-sm font-medium">Owner's Comp (%)</label><span id="val-comp-pct">50%</span></div>  
                            <input type="range" id="slider-comp" min="0" max="80" value="50" class="w-full" oninput="updateAllocationCalc()">  
                            <div class="flex justify-between"><label class="text-sm font-medium">Tax (%)</label><span id="val-tax-pct">15%</span></div>  
                            <input type="range" id="slider-tax" min="0" max="50" value="15" class="w-full" oninput="updateAllocationCalc()">  
                            <div class="h-2 w-full bg-slate-200 rounded-full overflow-hidden"><div id="bar-opex" class="h-full bg-slate-500" style="width: 30%"></div></div>  
                        </div>  
                    </div>  
                    <div class="lg:col-span-7 flex flex-col space-y-6">  
                        <div class="grid grid-cols-2 gap-4">  
                            <div class="bg-emerald-50 p-4 rounded-lg border-l-4 border-emerald-500">  
                                <p class="text-xs uppercase font-bold">Transfer to Profit</p>  
                                <p id="out-profit" class="text-2xl font-bold">$0</p>  
                            </div>  
                            <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-500">  
                                <p class="text-xs uppercase font-bold">Transfer to Pay</p>  
                                <p id="out-comp" class="text-2xl font-bold">$0</p>  
                            </div>  
                        </div>  
                        <div class="chart-container" style="height: 250px;">  
                            <canvas id="allocationDonut"></canvas>  
                        </div>  
                    </div>  
                </div>  
            </div>  
        </div>

        <!-- TAB 4: ROLLOUT & ✨ EXPENSE OPTIMIZER -->  
        <div id="tab-rollout" class="hidden space-y-12">  
            <div class="bg-white rounded-2xl p-8 shadow-sm border border-stone-100">  
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">  
                    <div class="space-y-6">  
                        <h3 class="text-2xl font-bold text-stone-800">✨ AI Expense Optimizer</h3>  
                        <p class="text-stone-600">Paste your recent credit card statement or a list of expenses here. Gemini will audit them based on Profit First "lean" principles.</p>  
                        <textarea id="expense-input" class="w-full h-48 border rounded-xl p-4 text-sm font-mono bg-stone-50" placeholder="E.g. Adobe $20, Amazon $140, Software subscription $15, Travel $500..."></textarea>  
                        <button id="btn-ai-audit" onclick="generateExpenseAudit()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 rounded-xl flex justify-center items-center gap-2 transition">  
                            <span id="ai-audit-text">✨ Audit My Expenses</span>  
                            <div id="ai-audit-loader" class="loading-spinner hidden"></div>  
                        </button>  
                    </div>  
                    <div class="space-y-6">  
                        <div id="audit-results" class="hidden space-y-4">  
                            <h4 class="font-bold text-stone-800">Audit Results:</h4>  
                            <div id="audit-table-container" class="overflow-hidden rounded-xl border border-stone-200">  
                                <table class="w-full text-left text-sm">  
                                    <thead class="bg-stone-100 text-stone-600 font-bold">  
                                        <tr>  
                                            <th class="p-3">Expense</th>  
                                            <th class="p-3">Action</th>  
                                            <th class="p-3">Why?</th>  
                                        </tr>  
                                    </thead>  
                                    <tbody id="audit-tbody" class="bg-white divide-y divide-stone-100"></tbody>  
                                </table>  
                            </div>  
                        </div>  
                        <div id="audit-placeholder" class="h-full flex flex-col items-center justify-center border-2 border-dashed border-stone-200 rounded-xl p-8 text-stone-400">  
                            <span class="text-4xl mb-2">&#128269;</span>  
                            <p>Paste data on the left to start the audit.</p>  
                        </div>  
                    </div>  
                </div>  
            </div>  
              
            <div class="bg-white p-6 rounded-xl shadow-sm border border-stone-100">  
                <h4 class="font-bold text-stone-800 mb-4 text-center">Your 1% Quarterly Glide Path</h4>  
                <div class="chart-container">  
                    <canvas id="rolloutChart"></canvas>  
                </div>  
            </div>  
        </div>

        <!-- TAB 5: ✨ AI COACH -->  
        <div id="tab-coach" class="hidden space-y-6">  
            <div class="max-w-3xl mx-auto bg-white rounded-2xl shadow-sm border border-stone-100 overflow-hidden">  
                <div class="bg-stone-800 p-6 text-white">  
                    <h3 class="text-xl font-bold flex items-center gap-2">✨ Methodology Coach</h3>  
                    <p class="text-stone-400 text-sm">Ask questions about applying Profit First to your specific business model.</p>  
                </div>  
                <div id="chat-history" class="h-96 overflow-y-auto p-6 space-y-4 bg-stone-50">  
                    <div class="bg-white p-3 rounded-lg border border-stone-200 text-sm text-stone-600">  
                        "Welcome! I am an expert in Mike Michalowicz's Profit First methodology. How can I help you today?"  
                    </div>  
                </div>  
                <div class="p-4 border-t bg-white">  
                    <div class="flex gap-2">  
                        <input type="text" id="chat-input" class="flex-grow border rounded-lg px-4 py-2 focus:ring-emerald-500 focus:border-emerald-500" placeholder="How do I handle business debt?">  
                        <button onclick="sendChatMessage()" class="bg-emerald-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-emerald-700 transition">Send</button>  
                    </div>  
                </div>  
            </div>  
        </div>

    </main>

    <footer class="bg-stone-800 text-stone-300 py-8 mt-auto">  
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">  
            <p class="text-sm">Profit First AI Dashboard &copy; <span id="current-year"></span></p>  
        </div>  
    </footer>

    <script>  
        // --- CONFIG & UTILS ---  
        async function geminiRequest(prompt, systemInstruction = "", isJson = false) {  
            const payload = { prompt, systemInstruction, isJson };

            for (let i = 0; i < 5; i++) {  
                try {  
                    const response = await fetch('/api/gemini', {  
                        method: 'POST',  
                        headers: { 'Content-Type': 'application/json' },  
                        body: JSON.stringify(payload)  
                    });  

                    if (!response.ok) {
                        const errorPayload = await response.json().catch(() => ({}));
                        throw new Error(errorPayload.error || 'API Error');
                    }

                    const data = await response.json();  
                    if (!data?.text) {
                        throw new Error('No response text received');
                    }
                    return data.text;  
                } catch (e) {
                    if (i === 4) {
                        throw e;
                    }
                    await new Promise(r => setTimeout(r, Math.pow(2, i) * 1000));  
                }  
            }  

            throw new Error('All retries failed');  
        }

        function parseModelJson(rawText) {
            const cleaned = String(rawText || '')
                .replace(/^```json\s*/i, '')
                .replace(/^```\s*/i, '')
                .replace(/\s*```$/i, '')
                .trim();

            try {
                return JSON.parse(cleaned);
            } catch {
                const start = cleaned.indexOf('{');
                const end = cleaned.lastIndexOf('}');
                if (start >= 0 && end > start) {
                    return JSON.parse(cleaned.slice(start, end + 1));
                }
                throw new Error('Unable to parse JSON response from model');
            }
        }

        function escapeHtml(value) {
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        // --- STATE ---  
        const state = {  
            currentTab: 'principles',  
            assessment: {  
                realRevenue: 0,  
                caps: { profit: 0, owner: 0, tax: 0, opex: 0 },  
                taps: { profit: 5, owner: 50, tax: 15, opex: 30 }  
            }  
        };

        let assessmentChartInstance = null;  
        let allocationDonutInstance = null;  
        let rolloutChartInstance = null;

        function switchTab(tabId) {  
            state.currentTab = tabId;  
            ['principles', 'assessment', 'calculator', 'rollout', 'coach'].forEach(t => {  
                const btn = document.getElementById(`nav-${t}`);  
                const section = document.getElementById(`tab-${t}`);  
                if (t === tabId) {  
                    btn.classList.add('active-tab');
                    btn.classList.remove('inactive-tab');
                    section.classList.remove('hidden');  
                } else {  
                    btn.classList.remove('active-tab');
                    btn.classList.add('inactive-tab');
                    section.classList.add('hidden');  
                }  
            });  

            document.getElementById('mobile-menu').classList.add('hidden');
            if (tabId === 'assessment' && !assessmentChartInstance) initAssessmentChart();  
            if (tabId === 'calculator') { updateAllocationCalc(); if(!allocationDonutInstance) initAllocationDonut(); }  
            if (tabId === 'rollout' && !rolloutChartInstance) initRolloutChart();  
        }

        // --- AI FEATURES ---

        async function generateAIHealthAnalysis() {  
            if (state.assessment.realRevenue <= 0) return;  
              
            const btn = document.getElementById('btn-ai-analyze');  
            const text = document.getElementById('ai-analyze-text');  
            const loader = document.getElementById('ai-analyze-loader');  
            const container = document.getElementById('ai-analysis-container');  
            const content = document.getElementById('ai-analysis-content');

            btn.disabled = true;  
            text.innerText = "Analyzing...";  
            loader.classList.remove('hidden');

            const prompt = `Based on these Profit First numbers:  
            Real Revenue: ${state.assessment.realRevenue}  
            Actuals (CAPs): Profit ${state.assessment.caps.profit}%, Owner Pay ${state.assessment.caps.owner}%, Tax ${state.assessment.caps.tax}%, OpEx ${state.assessment.caps.opex}%  
            Targets (TAPs): Profit ${state.assessment.taps.profit}%, Owner Pay ${state.assessment.taps.owner}%, Tax ${state.assessment.taps.tax}%, OpEx ${state.assessment.taps.opex}%  
            Provide 3 specific, encouraging, yet firm actionable steps to improve financial health. Keep it under 150 words.`;

            try {  
                const result = await geminiRequest(prompt, "You are an expert Profit First Certified Professional. Be encouraging and strategic.");  
                content.innerText = result;  
                container.classList.remove('hidden');  
            } catch (err) {  
                content.innerText = "Sorry, I couldn't connect to the AI brain right now. Please try again.";  
                container.classList.remove('hidden');  
            } finally {  
                btn.disabled = false;  
                text.innerText = "✨ Get AI Analysis";  
                loader.classList.add('hidden');  
            }  
        }

        async function generateExpenseAudit() {  
            const rawText = document.getElementById('expense-input').value;  
            if (!rawText.trim()) return;

            const btn = document.getElementById('btn-ai-audit');  
            const text = document.getElementById('ai-audit-text');  
            const loader = document.getElementById('ai-audit-loader');  
            const results = document.getElementById('audit-results');  
            const placeholder = document.getElementById('audit-placeholder');  
            const tbody = document.getElementById('audit-tbody');

            btn.disabled = true;  
            text.innerText = "Auditing...";  
            loader.classList.remove('hidden');

            const system = "You are an efficiency expert. Categorize expenses into 'Keep' (essential for production), 'Cut' (non-essential, luxury, or redundant), or 'Review' (can be replaced with cheaper alternative). Return JSON: { results: [{ item, action, why }] }";  
              
            try {  
                const response = await geminiRequest(`Audit these expenses: ${rawText}`, system, true);  
                const data = parseModelJson(response);
                if (!Array.isArray(data.results)) {
                    throw new Error('Invalid audit response');
                }
                  
                tbody.innerHTML = data.results.map(r => `  
                    <tr>  
                        <td class="p-3 font-medium text-stone-800">${escapeHtml(r.item)}</td>  
                        <td class="p-3">  
                            <span class="px-2 py-1 rounded-full text-xs font-bold ${  
                                r.action === 'Keep' ? 'bg-green-100 text-green-700' :   
                                r.action === 'Cut' ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700'  
                            }">${escapeHtml(r.action)}</span>  
                        </td>  
                        <td class="p-3 text-stone-500 italic">${escapeHtml(r.why)}</td>  
                    </tr>  
                `).join('');

                placeholder.classList.add('hidden');  
                results.classList.remove('hidden');  
            } catch (err) {  
                alert("AI audit failed. Try a smaller list.");  
            } finally {  
                btn.disabled = false;  
                text.innerText = "✨ Audit My Expenses";  
                loader.classList.add('hidden');  
            }  
        }

        async function sendChatMessage() {  
            const input = document.getElementById('chat-input');  
            const history = document.getElementById('chat-history');  
            const query = input.value.trim();  
            if (!query) return;

            const userDiv = document.createElement('div');  
            userDiv.className = "bg-blue-50 p-3 rounded-lg border border-blue-200 text-sm text-blue-900 ml-8 text-right";  
            userDiv.innerText = query;  
            history.appendChild(userDiv);  
            input.value = "";

            const loadingDiv = document.createElement('div');  
            loadingDiv.className = "bg-white p-3 rounded-lg border border-stone-200 text-sm text-stone-400 italic";  
            loadingDiv.innerText = "Coach is thinking...";  
            history.appendChild(loadingDiv);  
            history.scrollTop = history.scrollHeight;

            try {  
                const response = await geminiRequest(query, "You are a Profit First methodology coach. Only answer based on the books Profit First, Clockwork, or Fix This Next by Mike Michalowicz.");  
                loadingDiv.innerText = response;  
                loadingDiv.classList.remove('text-stone-400', 'italic');  
                loadingDiv.classList.add('text-stone-600');  
            } catch (e) {  
                loadingDiv.innerText = "The connection to the methodology vault was lost.";  
            }  
            history.scrollTop = history.scrollHeight;  
        }

        // --- CORE LOGIC (CALCS & CHARTS) ---

        function calculateAssessment() {  
            const rev = parseFloat(document.getElementById('input-revenue').value) || 0;  
            const mat = parseFloat(document.getElementById('input-materials').value) || 0;  
            const realRev = rev - mat;  
            document.getElementById('display-real-revenue').innerText = formatCurrency(realRev);  
            state.assessment.realRevenue = realRev;

            let taps = { profit: 5, owner: 50, tax: 15, opex: 30 };  
            if (realRev > 250000) taps = { profit: 10, owner: 35, tax: 15, opex: 40 };  
            if (realRev > 500000) taps = { profit: 15, owner: 20, tax: 15, opex: 50 };  
            state.assessment.taps = taps;

            const profitVal = parseFloat(document.getElementById('input-profit').value) || 0;  
            const payVal = parseFloat(document.getElementById('input-pay').value) || 0;  
            const taxVal = parseFloat(document.getElementById('input-tax').value) || 0;  
            const opexVal = parseFloat(document.getElementById('input-opex').value) || 0;  
            const calcBase = realRev > 0 ? realRev : 1;

            state.assessment.caps = {  
                profit: Math.round((profitVal / calcBase) * 100),  
                owner: Math.round((payVal / calcBase) * 100),  
                tax: Math.round((taxVal / calcBase) * 100),  
                opex: Math.round((opexVal / calcBase) * 100)  
            };

            if (assessmentChartInstance) {  
                assessmentChartInstance.data.datasets[0].data = [state.assessment.caps.profit, state.assessment.caps.owner, state.assessment.caps.tax, state.assessment.caps.opex];  
                assessmentChartInstance.data.datasets[1].data = [taps.profit, taps.owner, taps.tax, taps.opex];  
                assessmentChartInstance.update();  
            }  
            updateAssessmentFeedback(state.assessment.caps, taps);  
        }

        function updateAssessmentFeedback(caps, taps) {  
            const container = document.getElementById('assessment-feedback');  
            container.innerHTML = '';  
            Object.keys(taps).forEach(key => {  
                const diff = caps[key] - taps[key];  
                const label = key.charAt(0).toUpperCase() + key.slice(1);  
                let msg = diff < 0 ? `You are ${Math.abs(diff)}% short on ${label}.` : `${label} is covered.`;  
                if (key === 'opex') msg = diff > 0 ? `OpEx is ${diff}% over target.` : `OpEx is efficient.`;  
                const color = (key === 'opex' ? diff <= 0 : diff >= 0) ? 'border-green-400 bg-green-50' : 'border-amber-400 bg-amber-50';  
                container.innerHTML += `<div class="p-4 rounded-lg border-l-4 shadow-sm ${color}"><h4 class="font-bold">${label}</h4><p class="text-xs">${msg}</p></div>`;  
            });  
        }

        function updateAllocationCalc() {  
            const income = parseFloat(document.getElementById('calc-income').value) || 0;  
            const pPct = parseInt(document.getElementById('slider-profit').value);  
            const cPct = parseInt(document.getElementById('slider-comp').value);  
            const tPct = parseInt(document.getElementById('slider-tax').value);  
            let oPct = 100 - (pPct + cPct + tPct);  
            if (oPct < 0) oPct = 0;

            document.getElementById('val-profit-pct').innerText = pPct + "%";  
            document.getElementById('val-comp-pct').innerText = cPct + "%";  
            document.getElementById('val-tax-pct').innerText = tPct + "%";  
            document.getElementById('out-profit').innerText = formatCurrency(income * (pPct/100));  
            document.getElementById('out-comp').innerText = formatCurrency(income * (cPct/100));  
            document.getElementById('bar-opex').style.width = oPct + "%";

            if (allocationDonutInstance) {  
                allocationDonutInstance.data.datasets[0].data = [pPct, cPct, tPct, oPct];  
                allocationDonutInstance.update();  
            }  
        }

        function formatCurrency(num) { return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(num); }

        function initAssessmentChart() {  
            const ctx = document.getElementById('assessmentChart').getContext('2d');  
            assessmentChartInstance = new Chart(ctx, {  
                type: 'bar',  
                data: {  
                    labels: ['Profit', 'Owner Pay', 'Tax', 'OpEx'],  
                    datasets: [  
                        { label: 'Current (CAPs)', data: [0, 0, 0, 0], backgroundColor: '#A8A29E', borderRadius: 4 },  
                        { label: 'Target (TAPs)', data: [5, 50, 15, 30], backgroundColor: ['#10B981', '#3B82F6', '#F59E0B', '#64748B'], borderRadius: 4 }  
                    ]  
                },  
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100 } } }  
            });  
        }

        function initAllocationDonut() {  
            const ctx = document.getElementById('allocationDonut').getContext('2d');  
            allocationDonutInstance = new Chart(ctx, {  
                type: 'doughnut',  
                data: {  
                    labels: ['Profit', 'Owner Pay', 'Tax', 'OpEx'],  
                    datasets: [{ data: [5, 50, 15, 30], backgroundColor: ['#10B981', '#3B82F6', '#F59E0B', '#64748B'], borderWidth: 0 }]  
                },  
                options: { responsive: true, maintainAspectRatio: false }  
            });  
        }

        function initRolloutChart() {  
            const ctx = document.getElementById('rolloutChart').getContext('2d');  
            rolloutChartInstance = new Chart(ctx, {  
                type: 'line',  
                data: {  
                    labels: ['Start', 'Q1', 'Q2', 'Q3', 'Q4', 'Q5', 'Q6', 'Target'],  
                    datasets: [  
                        { label: 'Profit %', data: [1, 2, 3, 4, 6, 8, 11, 15], borderColor: '#10B981', tension: 0.3 },  
                        { label: 'OpEx %', data: [80, 77, 74, 70, 65, 60, 55, 50], borderColor: '#64748B', borderDash: [5, 5], tension: 0.3 }  
                    ]  
                },  
                options: { responsive: true, maintainAspectRatio: false }  
            });  
        }

        document.getElementById('current-year').innerText = new Date().getFullYear();
        calculateAssessment();
        updateAllocationCalc();

    </script>  
</body>  
</html>  
